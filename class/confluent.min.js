var __extends=this&&this.__extends||function(a,b){function d(){this.constructor=a}for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);a.prototype=null===b?Object.create(b):(d.prototype=b.prototype,new d)},Main=function(){function a(a,b,c,d){this.frame=0,this.graph=b,this.nodes=this.graph.nodes().toArray(),this.links=this.graph.links().toArray(),this.interface_=new Visualisation(a,c,d),this.confluentGraph=new ConfluentGraph(this.nodes,this.links,this.interface_.scene),this._UI=new UI(this.confluentGraph,this.interface_.scene,this.interface_.camera,this.interface_.renderer,this.interface_.raycaster),console.log("LAUNCH"),this.launch_animation(60)}return a.prototype.launch_animation=function(a){var b=this;this.refreshIntervalId=setInterval(function(){b.render(),b.frame++},a)},a.prototype.render=function(){this.confluentGraph.update(),this.interface_.renderer.render(this.interface_.scene,this.interface_.camera)},a.prototype.animate=function(){var a=this;requestAnimationFrame(a.animate.bind(a));a.render(),a.frame++},a}(),Visualisation=function(){function a(a,b,c){this.WIDTH=b,this.HEIGHT=c,this.div_element=a,this.init()}return a.prototype.init=function(){this.camera=new THREE.OrthographicCamera(this.WIDTH/-2,this.WIDTH/2,this.HEIGHT/2,this.HEIGHT/-2,1,5e3),this.camera.position.z=1e3,this.scene=new THREE.Scene,this.light=new THREE.DirectionalLight(16777215),this.light.position.set(0,1,1).normalize(),this.renderer=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0}),this.renderer.setSize(this.WIDTH,this.HEIGHT),this.renderer.setClearColor(3426654,1),this.renderer.sortObjects=!0,$(this.div_element).append(this.renderer.domElement),console.log("HEY",this.div_element),this.raycaster=new THREE.Raycaster},a}(),Drop_Down=function(){function a(a,b,c,d){this.container=d3.select(b).append("div").attr("class","graph").attr("id",d),this.link_id=c,this.ConfluentGraph=a,this.id=d,this.make_options(),this.make_UI()}return a.prototype.make_options=function(){switch(this.id){case"texture":this.data=[{name:" --- Select the particle form --- ",URL:""},{name:"square",URL:"square_texture.png"},{name:"circle",URL:"circle_texture.png"},{name:"rectangle",URL:"rectangle_texture.png"},{name:"star",URL:"star_texture.png"},{name:"informations",URL:"informations_texture.png"},{name:"triangle",URL:"triangle_texture.png"},{name:"arrow",URL:"arrow_texture.png"}]}},a.prototype.make_UI=function(){this.make_slider()},a.prototype.make_slider=function(){var a=this,b=this.container.append("div").append("select").on("change",function(){a.update_values(this.value)});b.selectAll("option").data(this.data).enter().append("option").attr("value",function(a){return a.URL}).text(function(a){return a.name})},a.prototype.update_values=function(a){"texture"==this.id&&this.ConfluentGraph.updateParticles_Texture(this.link_id,a)},a.prototype.get_values=function(){var a=0,b=this.ConfluentGraph.links[this.link_id].particleSystems.material.__webglShader.uniforms;return"texture"==this.id&&(a=b.texture.name),a},a}(),UIInformations_general=function(){function a(a,b){this.container=d3.select(b).append("div").attr("class","graph").attr("id","general_infos"),this.ConfluentGraph=a,this.make_header(),this.make_color_picker(),this.make_slider_frame(),this.change_color()}return a.prototype.change_color=function(){$("#color_bg_selector").on("change",function(a,b){console.log(b);var c=new THREE.Color;c.r=b._r/255,c.g=b._g/255,c.b=b._b/255,renderer.setClearColor(c,1)})},a.prototype.make_header=function(){this.container.append("div").attr("id","header_general_properties").append("text").text(" General Properties : ")},a.prototype.make_color_picker=function(){this.container.append("text").text("Background Color : "),this.container.append("input").attr("id","color_bg_selector"),$("#color_bg_selector").spectrum({preferredFormat:"hsl",showInput:!0,color:0})},a.prototype.make_slider_frame=function(){var b=this.container.append("div").attr("id","frame_rate").append("text").text("Frame rate : ");b.append("input").attr("type","range").attr("min","0").attr("max","500").attr("id","input_frame").attr("value",function(){this.value=frame_rate}).on("input",function(){clearInterval(refreshIntervalId),launch_animation(this.value),d3.select("#label_input_frame").text(this.value),frame_rate=this.value}),b.append("label").attr("for","input_frame").attr("id","label_input_frame").text(frame_rate)},a}(),Slider_Button=function(){function a(a,b,c,d,e){this.container=d3.select(b).append("div").attr("class","graph").attr("id",e),this.link_id=c,this.ConfluentGraph=a,this.id=e,this.gate=d,this.make_options(),this.make_UI()}return a.prototype.make_options=function(){switch(this.id){case"velocity":this.min=0,this.max=1.9,this.step=.1;break;case"size":this.min=10,this.max=150,this.step=10;break;case"opacity":this.min=0,this.max=1,this.step=.1;break;case"wiggling":this.min=0,this.max=1,this.step=.1;break;case"link_width":this.min=0,this.max=5,this.step=.1}},a.prototype.make_UI=function(){this.make_slider()},a.prototype.make_slider=function(){var a=this,b=this.container.append("div").append("text").text("Particle "+this.id+" : ");b.append("input").attr("type","range").attr("min",a.min).attr("max",a.max).attr("step",a.step).attr("id","input_alpha").attr("value",function(){this.value=a.get_values()}).on("input",function(){a.update_values(parseFloat(this.value)),d3.select("#label_input"+a.id).text(this.value)}),b.append("label").attr("for","input_frame").attr("id","label_input"+a.id).text(function(){return a.get_values()})},a.prototype.update_values=function(a){var b=this;"velocity"==this.id&&this.ConfluentGraph.updateParticles_Velocity(this.link_id,this.gate,a),"size"==this.id&&this.ConfluentGraph.updateParticles_Size(this.link_id,this.gate,a),"opacity"==this.id&&this.ConfluentGraph.updateParticles_Opacity(this.link_id,this.gate,a),"wiggling"==this.id&&this.ConfluentGraph.updateParticles_Wiggling(this.link_id,this.gate,a),"link_width"==this.id&&(this.ConfluentGraph.updateLinks_width_gate(this.link_id,this.gate,a),b.ConfluentGraph.updateTube_width_gate(b.link_id,b.gate,a))},a.prototype.get_values=function(){var a=0,b=this.ConfluentGraph.links[this.link_id].particleSystems.material.__webglShader.uniforms;return"velocity"==this.id&&(a=b.velocity.value[this.gate]),"size"==this.id&&(a=b.size.value[this.gate]),"opacity"==this.id&&(a=b.opacity.value[this.gate]),"wiggling"==this.id&&(a=b.wiggling.value[this.gate]),"link_width"==this.id&&(a=this.ConfluentGraph.links[this.link_id].gate_infos[this.gate].factor),a},a}(),LinkAppearance=function(){function a(a,b,c){this.container=d3.select(b).append("div").attr("class","graph").attr("id","link"),this.link_id=c,this.ConfluentGraph=a,this.make_UI(),this.change_color()}return a.prototype.change_color=function(){var a=this;$("#color_picker_link").on("change",function(b,c){var d=c.toHex();d="0x"+d,a.ConfluentGraph.tube[a.link_id].children[0].material.color.setHex(d)})},a.prototype.make_alpha_gates=function(){var a=this,b=this.container.append("div").attr("id","alpha_gates_selector").append("text").text("Gates alpha : ");b.append("input").attr("type","range").attr("min","0").attr("max","1").attr("step","0.01").attr("id","input_alpha").attr("value",function(){var b=a.ConfluentGraph.links[a.link_id].gates;void 0!=b[1]&&(this.value=b[1].object.material.opacity)}).on("input",function(){for(var b=a.ConfluentGraph.links[a.link_id].gates,c=1;c<b.length;c++)b[c].object.material.opacity=this.value;d3.select("#alpha_gates").text(this.value)}),b.append("label").attr("for","input_frame").attr("id","alpha_gates").text(function(){var b=a.ConfluentGraph.links[a.link_id].gates;if(void 0!=b[1])return b[1].object.material.opacity})},a.prototype.make_alpha_tube_picker=function(){var a=this,b=this.container.append("div").attr("id","alpha_tube_selector").append("text").text("Tube alpha : ");b.append("input").attr("type","range").attr("min","0").attr("max","1").attr("step","0.01").attr("id","input_alpha").attr("value",function(){this.value=a.ConfluentGraph.tube[a.link_id].children[0].material.opacity}).on("input",function(){console.log("MY TUBE",a.ConfluentGraph.tube[a.link_id]),a.ConfluentGraph.tube[a.link_id].children[0].material.opacity=this.value,d3.select("#alpha_tube").text(this.value)}),b.append("label").attr("for","input_frame").attr("id","alpha_tube").text(function(){return a.ConfluentGraph.tube[a.link_id].children[0].material.opacity})},a.prototype.make_alpha_links_picker=function(){var a=this,b=this.container.append("div").attr("id","alpha_links_selector").append("text").text("Links alpha : ");b.append("input").attr("type","range").attr("min","0").attr("max","1").attr("step","0.01").attr("id","input_alpha").attr("value",function(){this.value=a.ConfluentGraph.curveSplines[a.link_id].children[0].material.opacity}).on("input",function(){for(var b=a.ConfluentGraph.curveSplines[a.link_id].children,c=0;c<b.length;c++)b[c].material.opacity=this.value;d3.select("#alpha_links").text(this.value)}),b.append("label").attr("for","input_frame").attr("id","alpha_links").text(function(){return a.ConfluentGraph.curveSplines[a.link_id].children[0].material.opacity})},a.prototype.make_color_picker=function(){var a=this,b=a.ConfluentGraph.tube[this.link_id].children[0].material.color.getHSL();console.log("MY COLOR IS ",b),this.container.append("text").text("Tube Color :"),this.container.append("input").attr("id","color_picker_link"),$("#color_picker_link").spectrum({preferredFormat:"hsl",showInput:!0,color:"hsl("+100*b.h+","+100*b.s+","+100*b.l+")"})},a.prototype.change_tube_width=function(){var a=this,b=this.container.append("div").attr("id","width_links").append("text").text("Width Links : ");b.append("input").attr("type","range").attr("min","0").attr("max","10").attr("step","0.5").attr("id","input_width").attr("value",function(){this.value=a.ConfluentGraph.links[a.link_id].width_tube}).on("input",function(){a.ConfluentGraph.links[a.link_id].width_tube=parseFloat(this.value),a.ConfluentGraph.updateLinks(),a.ConfluentGraph.updateParticles_Paths(a.link_id),a.ConfluentGraph.updateTube(),d3.select("#tube_width").text(this.value)}),b.append("label").attr("for","input_frame").attr("id","tube_width").text(function(){return a.ConfluentGraph.links[a.link_id].width_tube})},a.prototype.make_header=function(){this.container.append("div").attr("id","header_tube_properties").append("text").text(" Tube Properties : ")},a.prototype.make_UI=function(){this.make_header(),this.make_color_picker(),this.make_alpha_tube_picker(),this.make_alpha_links_picker(),this.change_tube_width(),this.make_alpha_gates()},a}(),UIInformations=function(){function a(a,b,c){this.container=d3.select(b).append("div").attr("class","graph").attr("id","informations"),this.link_id=c,this.ConfluentGraph=a,this.make_infos()}return a.prototype.make_infos=function(){var a=this.ConfluentGraph.links[this.link_id].userData.number_particles;this.container.append("div").text("Informations :"),this.container.append("div").text("Links nÂ° "+this.link_id),this.container.append("div").text(a+" particles")},a}(),ColorPicker=function(){function a(a,b,c,d){this.container=d3.select(b).append("div").attr("class","graph").attr("id","picker"),this.link_id=c,this.ConfluentGraph=a,this.gate=d,this.make_color_picker(),this.listen_events()}return a.prototype.retrieve_color_gate=function(){var a=this.ConfluentGraph.links[this.link_id].particleSystems.material.__webglShader.uniforms,b=a.gate_colors.value[this.gate],c=new THREE.Vector3(b.x,b.y,b.z);c=c.multiplyScalar(255);var d="rgb("+c.x+","+c.y+","+c.z+")";return console.log(d),d},a.prototype.make_color_picker=function(){console.log("YOOOOOOO");var a=this;this.container.append("text").text("Change color Gate :"),this.container.append("input").attr("id","color_picker"),$("#color_picker").spectrum({preferredFormat:"rgb",showInput:!0,color:a.retrieve_color_gate()})},a.prototype.listen_events=function(){var a=this;$("#color_picker").on("change",function(b,c){console.log(c.toRgb());var c=c.toRgb();a.ConfluentGraph.updateParticles_Color(a.link_id,c,a.gate)})},a}(),UI=function(){function a(a,b,c,d,e){this.mouse={x:null,y:null},this.slider1=null,this.slider2=null,this.gate=null,this.selected_object=[],this.ConfluentGraph=a,this.state_machine={state:"click_infos"},this.mouse_raycaster={position:new THREE.Vector2,beginning:!0},this.scene=b,this.camera=c,this.renderer=d,this.raycaster=e,this.get_top_bar_actions(),this.onclick_reduce_side_bar(),this.mouse_event()}return a.prototype.update_graph=function(a){this.delete_graph(),this.gate=new UIGate(this.ConfluentGraph,"#temporal_control",a)},a.prototype.delete_graph=function(){this.mouse.x<window.innerWidth-300&&(d3.select("#temporal_control").selectAll("*").remove(),d3.select("#general").selectAll("*").remove())},a.prototype.onclick_reduce_side_bar=function(){d3.select("#icon_reduce_bar").on("click",function(){var a=d3.select(this).attr("active");"false"==a?(d3.select(this).selectAll("*").remove(),d3.select(this).append("span").attr("class","fa fa-chevron-circle-left"),d3.select("#sliderDiv").style("transform","translate(250px, 0px)"),d3.select(this).attr("active","true")):(d3.select(this).selectAll("*").remove(),d3.select(this).append("span").attr("class","fa fa-chevron-circle-right"),d3.select("#sliderDiv").style("transform","translate(0px, 0px)"),d3.select(this).attr("active","false"))})},a.prototype.get_top_bar_actions=function(){var a=this;$("#bar_position").click(function(){a.state_machine.state="position_bar",console.log("MODE ",a.state_machine.state),console.log(a.ConfluentGraph.links)}),$("#mouse").click(function(){a.state_machine.state="click_infos",console.log("MODE ",a.state_machine.state)}),$("#zoom_in").click(function(){event.preventDefault(),a.camera.zoom-=.1,a.camera.updateProjectionMatrix()}),$("#zoom_out").click(function(){event.preventDefault(),a.camera.zoom+=.1,a.camera.updateProjectionMatrix()})},a.prototype.mouse_event=function(){function f(d){a.mouse.x=d.clientX,a.mouse.y=d.clientY,console.log(d.clientX),b=[d.clientX,d.clientY],c=[a.camera.position.x,a.camera.position.y],e=!0}function g(a){e=!1}function h(f){e&&(d=[f.clientX-b[0],f.clientY-b[1]],a.camera.position.x=c[0]-d[0]/a.camera.zoom,a.camera.position.y=c[1]+d[1]/a.camera.zoom)}function i(b){b.preventDefault(),a.camera.zoom+=b.wheelDelta/1e3,a.camera.updateProjectionMatrix()}function j(b){b.clientX<window.innerWidth-300&&(a.mouse_raycaster.beginning=!1,b.preventDefault(),a.mouse_raycaster.position.x=b.clientX/a.renderer.domElement.clientWidth*2-1,a.mouse_raycaster.position.y=2*-(b.clientY/a.renderer.domElement.clientHeight)+1,a.get_intersections())}var a=this;window.addEventListener("mousedown",f,!1),window.addEventListener("mouseup",g,!1),window.addEventListener("mousemove",h,!1),window.addEventListener("mousewheel",i,!1),window.addEventListener("click",j,!1);var b=[],c=[],d=[],e=!1},a.prototype.get_intersections=function(){var a=this;if(0==a.mouse_raycaster.beginning){a.raycaster.setFromCamera(a.mouse_raycaster.position,a.camera);var b=a.raycaster.intersectObjects(a.scene.children,!0);if(0!=b.length){var c=b[0].object,d=c.parent.userData.type,e=c.parent.userData.id;switch(a.state_machine.state){case"click_infos":"tube"!=d&&"link"!=d||a.update_graph(c.parent.userData.id);break;case"position_bar":if("tube"==d||"link"==d){var f=b[0].point.x,g=b[0].point.y,h=a.ConfluentGraph.links[e].source.x,i=a.ConfluentGraph.links[e].source.y,j=a.ConfluentGraph.links[e].target.x,k=a.ConfluentGraph.links[e].target.y,l=a.get_normal_position(f,g,h,i,j,k,5),m=a.get_segments(l[0].x,l[0].y,h,i,j,k);a.ConfluentGraph.create_gates(e,m,l[1].x,l[1].y,l[2].x,l[2].y),a.ConfluentGraph.updateParticles_Gates(e,m),null!=a.gate&&a.update_graph(c.parent.userData.id)}}}}},a.prototype.coloriate_tube=function(a){for(var b=this,c=0;c<this.ConfluentGraph.tube.length;c++){var d=this.ConfluentGraph.tube[c];if(d.userData.id==a){var e=d.children[0];null!=b.selected_object&&b.selected_object.material.color.set(15132390),b.selected_object=e,e.material.color.set(16711680);break}}},a.prototype.get_segments=function(a,b,c,d,e,f){var g=(e-c)/50,h=a-c,i=Math.round(h/g);return i},a.prototype.get_normal_position=function(a,b,c,d,e,f,g){var h=[],i=(f-d)/(e-c),j=a,k=b,i=(f-d)/(e-c),l=f-i*e,m=(c-e)/(f-d),n=k-m*j,o=(n-l)/(i-m),p=i*o+l;h.push({x:o,y:p});var q=o+Math.sqrt(Math.pow(g,2)/(1+Math.pow(m,2))),r=m*q+n;h.push({x:q,y:r});var s=o-Math.sqrt(Math.pow(g,2)/(1+Math.pow(m,2))),t=m*s+n;return h.push({x:s,y:t}),h},a.prototype.draw_circle=function(a,b){var c=new THREE.MeshBasicMaterial({color:15658734}),d=50,e=new THREE.CircleGeometry(.5,d),f=new THREE.Mesh(e,c);f.scale.set(1,1,1),f.name="circle",f.position.set(a,b,1),this.scene.add(f)},a}(),UIGate=function(){function a(a,b,c){this.container=d3.select(b),this.link_id=c,this.confluent_graph=a,this.delete_UI(),this.make_UI_general(),this.make_UI()}return a.prototype.update_UI=function(){this.delete_UI(),this.change_appearanceLink(),this.make_graphs(0)},a.prototype.make_array=function(a){for(var b=[],c=0;c<a;c++)b[c]=c;return b},a.prototype.delete_UI=function(){console.log("DELETE"),this.container.selectAll(".graph").remove(),d3.select("#general").selectAll(".graph").remove()},a.prototype.make_UI=function(){function h(){var b=this.options[this.selectedIndex].value;a.delete_UI(),a.change_appearanceLink(),a.make_graphs(b)}this.change_appearanceLink();var a=this,c=(this.confluent_graph.links[this.link_id].gates,this.confluent_graph.links[this.link_id].gates.length),d=this.make_array(c),e=this.container.append("div").attr("id","select").append("text").text("Gate nÂ° : "),f=e.append("select").on("change",h);f.selectAll("option").data(d).enter().append("option").text(function(a){return a});a.make_graphs(0)},a.prototype.make_graphs=function(a){var b=this.confluent_graph.links[this.link_id].userData.number_particles,c=this.confluent_graph.links[this.link_id].temporal_distribution,d=this.confluent_graph.links[this.link_id].spatial_distribution,e=this.confluent_graph.links[this.link_id].temporal_distribution.length;0==a&&(this.slider1=new SliderButton(this.confluent_graph,"#temporal_control",this.link_id,b,c,a,e,"temporal"),this.slider2=new SliderButton(this.confluent_graph,"#temporal_control",this.link_id,b,d,a,12,"spatial"),this.velocity=new Slider_Button(this.confluent_graph,"#temporal_control",this.link_id,a,"velocity")),this.colorpicker=new ColorPicker(this.confluent_graph,"#temporal_control",this.link_id,a),this.link_width=new Slider_Button(this.confluent_graph,"#temporal_control",this.link_id,a,"link_width"),this.opacity=new Slider_Button(this.confluent_graph,"#temporal_control",this.link_id,a,"opacity"),this.size=new Slider_Button(this.confluent_graph,"#temporal_control",this.link_id,a,"size"),this.wiggling=new Slider_Button(this.confluent_graph,"#temporal_control",this.link_id,a,"wiggling")},a.prototype.change_appearanceLink=function(){this.informations=new UIInformations(this.confluent_graph,"#general",this.link_id),this.link_appearance=new LinkAppearance(this.confluent_graph,"#general",this.link_id),this.texture=new Drop_Down(this.confluent_graph,"#temporal_control",this.link_id,"texture")},a.prototype.make_UI_general=function(){this.informations_general=new UIInformations_general(this.confluent_graph,"#general")},a}(),SliderButton=function(){function a(b,c,d,e,f,g,h,i){this.my_link=1,this.particle=100,this.number_values_temporal=8,this.confluent_graph=b,this.SLIDER_WIDTH=400,this.SLIDER_HIGHT=150,this.gate_id=g,this.my_link=d,this.particle=e,this.values=f,this.number_values_temporal=h,this.type=i,this.container=d3.select(c).append("div").attr("class","graph").attr("id","graph"),this.id=a.ID,a.ID++;var j=this;this.title=this.particle+" particles / Link nÂ° "+j.my_link,this.makeSliderVertical(this.SLIDER_WIDTH,this.SLIDER_HIGHT,this.values,function(a){console.log("VALUE",a);var b=a;"temporal"==j.type?(j.confluent_graph.links[j.my_link].temporal_distribution=a,j.confluent_graph.updateParticles_TemporalDistribution(j.gate_id,b,j.my_link,j.number_values_temporal)):(j.confluent_graph.links[j.my_link].spatial_distribution=a,j.confluent_graph.updateParticles_SpatialDistribution(b,j.my_link)),j.update_graph(a)})}return a.prototype.update_graph=function(a){if(a.length!=this.number_values_temporal){for(var b=[],c=0;c<this.number_values_temporal;c++)b[c]=0;b[0]=this.particle,a=b}this.svg.selectAll("*").remove(),this.container.selectAll("select").remove(),this.slider.set(a),this.slider.appendTo(this.svg)},a.prototype.makeSliderVertical=function(a,b,c,d){function m(){e.number_values_temporal=parseInt(this.options[this.selectedIndex].value),e.update_graph(c)}var e=this;if(console.log("spatial",e.confluent_graph.links[e.my_link].spatial_distribution),c.length!=this.number_values_temporal){for(var f=[],g=0;g<this.number_values_temporal;g++)f[g]=0;f[0]=this.particle,c=f}var h=this.particle;if(this.slider=new MySlider(this.id,50,10,a,b,0,h,1,this.number_values_temporal),this.container.append("text").text(this.type+" distribution :"),this.svg=this.container.append("svg").attr("width",a).attr("height",b),this.slider.set(c),this.slider.appendTo(this.svg),this.slider.setDragEndCallBack(d),"temporal"==e.type){var i=[2,3,4,5,6,7,8,9,10],k=(this.container.append("text").text("Number of cycle : "),this.container.append("select").on("change",m));k.selectAll("option").data(i).enter().append("option").text(function(a){return a})}},a.ID=0,a}(),cola;!function(a){function c(a,c,d,e,f){function p(a){function b(a){var b=Number.MAX_VALUE,c=Number.MAX_VALUE,d=0,f=0;a.array.forEach(function(a){var g="undefined"!=typeof a.width?a.width:e,h="undefined"!=typeof a.height?a.height:e;g/=2,h/=2,d=Math.max(a.x+g,d),b=Math.min(a.x-g,b),f=Math.max(a.y+h,f),c=Math.min(a.y-h,c)}),a.width=d-b,a.height=f-c}a.forEach(function(a){b(a)})}function q(a){a.forEach(function(a){var b={x:0,y:0};a.array.forEach(function(a){b.x+=a.x,b.y+=a.y}),b.x/=a.array.length,b.y/=a.array.length;var c={x:b.x-a.width/2,y:b.y-a.height/2},d={x:a.x-c.x,y:a.y-c.y};a.array.forEach(function(a){a.x=a.x+d.x+i/2-k/2,a.y=a.y+d.y+j/2-l/2})})}function r(a,c){var d=Number.POSITIVE_INFINITY,e=0;a.sort(function(a,b){return b.height-a.height}),m=a.reduce(function(a,b){return a.width<b.width?a.width:b.width});for(var f=o=m,g=p=u(a),h=0,i=Number.MAX_VALUE,j=Number.MAX_VALUE,k=-1,l=Number.MAX_VALUE,n=Number.MAX_VALUE;l>m||n>b.FLOAT_EPSILON;){if(1!=k)var o=g-(g-f)/b.GOLDEN_SECTION,i=s(a,o);if(0!=k)var p=f+(g-f)/b.GOLDEN_SECTION,j=s(a,p);if(l=Math.abs(o-p),n=Math.abs(i-j),i<d&&(d=i,e=o),j<d&&(d=j,e=p),i>j?(f=o,o=p,i=j,k=1):(g=p,p=o,j=i,k=0),h++>100)break}s(a,e)}function s(a,b){o=[],k=0,l=0,n=h;for(var c=0;c<a.length;c++){var d=a[c];t(d,b)}return Math.abs(v()-f)}function t(a,c){for(var d=void 0,e=0;e<o.length;e++)if(o[e].space_left>=a.height&&o[e].x+o[e].width+a.width+b.PADDING-c<=b.FLOAT_EPSILON){d=o[e];break}o.push(a),void 0!==d?(a.x=d.x+d.width+b.PADDING,a.y=d.bottom,a.space_left=a.height,a.bottom=a.y,d.space_left-=a.height+b.PADDING,d.bottom+=a.height+b.PADDING):(a.y=n,n+=a.height+b.PADDING,a.x=g,a.bottom=a.y,a.space_left=a.height),a.y+a.height-l>-b.FLOAT_EPSILON&&(l=a.y+a.height-h),a.x+a.width-k>-b.FLOAT_EPSILON&&(k=a.x+a.width-g)}function u(a){var c=0;return a.forEach(function(a){return c+=a.width+b.PADDING}),c}function v(){return k/l}void 0===f&&(f=1);var g=0,h=0,i=c,j=d,f="undefined"!=typeof f?f:1,e="undefined"!=typeof e?e:0,k=0,l=0,m=0,n=0,o=[];0!=a.length&&(p(a),r(a,f),q(a))}function d(a,b){function l(a,b){if(void 0===c[a.index]){b&&(f++,e.push({array:[]})),c[a.index]=f,e[f-1].array.push(a);var g=d[a.index];if(g)for(var h=0;h<g.length;h++)l(g[h],!1)}}for(var c={},d={},e=[],f=0,g=0;g<b.length;g++){var h=b[g],i=h.source,j=h.target;d[i.index]?d[i.index].push(j):d[i.index]=[j],d[j.index]?d[j.index].push(i):d[j.index]=[i]}for(var g=0;g<a.length;g++){var k=a[g];c[k.index]||l(k,!0)}return e}var b={PADDING:10,GOLDEN_SECTION:(1+Math.sqrt(5))/2,FLOAT_EPSILON:1e-4,MAX_INERATIONS:100};a.applyPacking=c,a.separateGraphs=d}(cola||(cola={}));var cola;!function(a){var b;!function(a){var b=function(){function a(a){this.scale=a,this.AB=0,this.AD=0,this.A2=0}return a.prototype.addVariable=function(a){var b=this.scale/a.scale,c=a.offset/a.scale,d=a.weight;this.AB+=d*b*c,this.AD+=d*b*a.desiredPosition,this.A2+=d*b*b},a.prototype.getPosn=function(){return(this.AD-this.AB)/this.A2},a}();a.PositionStats=b;var c=function(){function a(a,b,c,d){void 0===d&&(d=!1),this.left=a,this.right=b,this.gap=c,this.equality=d,this.active=!1,this.unsatisfiable=!1,this.left=a,this.right=b,this.gap=c,this.equality=d}return a.prototype.slack=function(){return this.unsatisfiable?Number.MAX_VALUE:this.right.scale*this.right.position()-this.gap-this.left.scale*this.left.position()},a}();a.Constraint=c;var d=function(){function a(a,b,c){void 0===b&&(b=1),void 0===c&&(c=1),this.desiredPosition=a,this.weight=b,this.scale=c,this.offset=0}return a.prototype.dfdv=function(){return 2*this.weight*(this.position()-this.desiredPosition)},a.prototype.position=function(){return(this.block.ps.scale*this.block.posn+this.offset)/this.scale},a.prototype.visitNeighbours=function(a,b){var c=function(c,d){return c.active&&a!==d&&b(c,d)};this.cOut.forEach(function(a){return c(a,a.right)}),this.cIn.forEach(function(a){return c(a,a.left)})},a}();a.Variable=d;var e=function(){function a(a){this.vars=[],a.offset=0,this.ps=new b(a.scale),this.addVariable(a)}return a.prototype.addVariable=function(a){a.block=this,this.vars.push(a),this.ps.addVariable(a),this.posn=this.ps.getPosn()},a.prototype.updateWeightedPosition=function(){this.ps.AB=this.ps.AD=this.ps.A2=0;for(var a=0,b=this.vars.length;a<b;++a)this.ps.addVariable(this.vars[a]);this.posn=this.ps.getPosn()},a.prototype.compute_lm=function(a,b,c){var d=this,e=a.dfdv();return a.visitNeighbours(b,function(b,f){var g=d.compute_lm(f,a,c);f===b.right?(e+=g*b.left.scale,b.lm=g):(e+=g*b.right.scale,b.lm=-g),c(b)}),e/a.scale},a.prototype.populateSplitBlock=function(a,b){var c=this;a.visitNeighbours(b,function(b,d){d.offset=a.offset+(d===b.right?b.gap:-b.gap),c.addVariable(d),c.populateSplitBlock(d,a)})},a.prototype.traverse=function(a,b,c,d){var e=this;void 0===c&&(c=this.vars[0]),void 0===d&&(d=null),c.visitNeighbours(d,function(d,f){b.push(a(d)),e.traverse(a,b,f,c)})},a.prototype.findMinLM=function(){var a=null;return this.compute_lm(this.vars[0],null,function(b){!b.equality&&(null===a||b.lm<a.lm)&&(a=b)}),a},a.prototype.findMinLMBetween=function(a,b){this.compute_lm(a,null,function(){});var c=null;return this.findPath(a,null,b,function(a,b){!a.equality&&a.right===b&&(null===c||a.lm<c.lm)&&(c=a)}),c},a.prototype.findPath=function(a,b,c,d){var e=this,f=!1;return a.visitNeighbours(b,function(b,g){f||g!==c&&!e.findPath(g,a,c,d)||(f=!0,d(b,g))}),f},a.prototype.isActiveDirectedPathBetween=function(a,b){if(a===b)return!0;for(var c=a.cOut.length;c--;){var d=a.cOut[c];if(d.active&&this.isActiveDirectedPathBetween(d.right,b))return!0}return!1},a.split=function(b){return b.active=!1,[a.createSplitBlock(b.left),a.createSplitBlock(b.right)]},a.createSplitBlock=function(b){var c=new a(b);return c.populateSplitBlock(b,null),c},a.prototype.splitBetween=function(b,c){var d=this.findMinLMBetween(b,c);if(null!==d){var e=a.split(d);return{constraint:d,lb:e[0],rb:e[1]}}return null},a.prototype.mergeAcross=function(a,b,c){b.active=!0;for(var d=0,e=a.vars.length;d<e;++d){var f=a.vars[d];f.offset+=c,this.addVariable(f)}this.posn=this.ps.getPosn()},a.prototype.cost=function(){for(var a=0,b=this.vars.length;b--;){var c=this.vars[b],d=c.position()-c.desiredPosition;a+=d*d*c.weight}return a},a}();a.Block=e;var f=function(){function a(a){this.vs=a;var b=a.length;for(this.list=new Array(b);b--;){var c=new e(a[b]);this.list[b]=c,c.blockInd=b}}return a.prototype.cost=function(){for(var a=0,b=this.list.length;b--;)a+=this.list[b].cost();return a},a.prototype.insert=function(a){a.blockInd=this.list.length,this.list.push(a)},a.prototype.remove=function(a){var b=this.list.length-1,c=this.list[b];this.list.length=b,a!==c&&(this.list[a.blockInd]=c,c.blockInd=a.blockInd)},a.prototype.merge=function(a){var b=a.left.block,c=a.right.block,d=a.right.offset-a.left.offset-a.gap;b.vars.length<c.vars.length?(c.mergeAcross(b,a,d),this.remove(b)):(b.mergeAcross(c,a,-d),this.remove(c))},a.prototype.forEach=function(a){this.list.forEach(a)},a.prototype.updateBlockPositions=function(){this.list.forEach(function(a){return a.updateWeightedPosition()})},a.prototype.split=function(a){var b=this;this.updateBlockPositions(),this.list.forEach(function(c){var d=c.findMinLM();null!==d&&d.lm<g.LAGRANGIAN_TOLERANCE&&(c=d.left.block,e.split(d).forEach(function(a){return b.insert(a)}),b.remove(c),a.push(d))})},a}();a.Blocks=f;var g=function(){function a(a,b){this.vs=a,this.cs=b,this.vs=a,a.forEach(function(a){a.cIn=[],a.cOut=[]}),this.cs=b,b.forEach(function(a){a.left.cOut.push(a),a.right.cIn.push(a)}),this.inactive=b.map(function(a){return a.active=!1,a}),this.bs=null}return a.prototype.cost=function(){return this.bs.cost()},a.prototype.setStartingPositions=function(a){this.inactive=this.cs.map(function(a){return a.active=!1,a}),this.bs=new f(this.vs),this.bs.forEach(function(b,c){return b.posn=a[c]})},a.prototype.setDesiredPositions=function(a){this.vs.forEach(function(b,c){return b.desiredPosition=a[c]})},a.prototype.mostViolated=function(){for(var b=Number.MAX_VALUE,c=null,d=this.inactive,e=d.length,f=e,g=0;g<e;++g){var h=d[g];if(!h.unsatisfiable){var i=h.slack();if((h.equality||i<b)&&(b=i,c=h,f=g,h.equality))break}}return f!==e&&(b<a.ZERO_UPPERBOUND&&!c.active||c.equality)&&(d[f]=d[e-1],d.length=e-1),c},a.prototype.satisfy=function(){null==this.bs&&(this.bs=new f(this.vs)),this.bs.split(this.inactive);for(var b=null;(b=this.mostViolated())&&(b.equality||b.slack()<a.ZERO_UPPERBOUND&&!b.active);){var c=b.left.block,d=b.right.block;if(c!==d)this.bs.merge(b);else{if(c.isActiveDirectedPathBetween(b.right,b.left)){b.unsatisfiable=!0;continue}var e=c.splitBetween(b.left,b.right);if(null===e){b.unsatisfiable=!0;continue}this.bs.insert(e.lb),this.bs.insert(e.rb),this.bs.remove(c),this.inactive.push(e.constraint),b.slack()>=0?this.inactive.push(b):this.bs.merge(b)}}},a.prototype.solve=function(){this.satisfy();for(var a=Number.MAX_VALUE,b=this.bs.cost();Math.abs(a-b)>1e-4;)this.satisfy(),a=b,b=this.bs.cost();return b},a.LAGRANGIAN_TOLERANCE=-1e-4,a.ZERO_UPPERBOUND=-1e-10,a}();a.Solver=g}(b=a.vpsc||(a.vpsc={}))}(cola||(cola={}));var cola;!function(a){var b;!function(a){function b(a){return a.bounds="undefined"!=typeof a.leaves?a.leaves.reduce(function(a,b){return b.bounds.union(a)},c.empty()):c.empty(),"undefined"!=typeof a.groups&&(a.bounds=a.groups.reduce(function(a,c){return b(c).union(a)},a.bounds)),a.bounds=a.bounds.inflate(a.padding),a.bounds}function d(a,b,c,d){var e=b.rayIntersection(c.cx(),c.cy());e||(e={x:b.cx(),y:b.cy()});var f=c.rayIntersection(b.cx(),b.cy());f||(f={x:c.cx(),y:c.cy()});var g=f.x-e.x,h=f.y-e.y,i=Math.sqrt(g*g+h*h),j=i-d;a.sourceIntersection=e,a.targetIntersection=f,a.arrowStart={x:e.x+j*g/i,y:e.y+j*h/i}}function e(a,b,c){var d=b.rayIntersection(a.x,a.y);d||(d={x:b.cx(),y:b.cy()});var e=d.x-a.x,f=d.y-a.y,g=Math.sqrt(e*e+f*f);return{x:d.x-c*e/g,y:d.y-c*f/g}}function h(a,b){return a.pos>b.pos?1:a.pos<b.pos?-1:a.isOpen?-1:0}function i(){return new RBTree(function(a,b){return a.pos-b.pos})}function l(a,b,c,d){void 0===d&&(d=!1);var e=a.padding,f="undefined"!=typeof a.groups?a.groups.length:0,g="undefined"!=typeof a.leaves?a.leaves.length:0,h=f?a.groups.reduce(function(a,d){return a.concat(l(d,b,c,!0))},[]):[],i=(d?2:0)+g+f,j=new Array(i),k=new Array(i),n=0,o=function(a,b){k[n]=a,j[n++]=b};if(d){var p=a.bounds,q=b.getCentre(p),r=b.getSize(p)/2,s=b.getOpen(p),t=b.getClose(p),u=q-r+e/2,v=q+r-e/2;a.minVar.desiredPosition=u,o(b.makeRect(s,t,u,e),a.minVar),a.maxVar.desiredPosition=v,o(b.makeRect(s,t,v,e),a.maxVar)}g&&a.leaves.forEach(function(a){return o(a.bounds,a.variable)}),f&&a.groups.forEach(function(a){var c=a.bounds;o(b.makeRect(b.getOpen(c),b.getClose(c),b.getCentre(c),b.getSize(c)),a.minVar);
});var w=m(k,j,b,c);return f&&(j.forEach(function(a){a.cOut=[],a.cIn=[]}),w.forEach(function(a){a.left.cOut.push(a),a.right.cIn.push(a)}),a.groups.forEach(function(a){var c=(a.padding-b.getSize(a.bounds))/2;a.minVar.cIn.forEach(function(a){return a.gap+=c}),a.minVar.cOut.forEach(function(b){b.left=a.maxVar,b.gap+=c})})),h.concat(w)}function m(b,c,d,e){var j,k=b.length,l=2*k;console.assert(c.length>=k);var m=new Array(l);for(j=0;j<k;++j){var n=b[j],o=new f(c[j],n,d.getCentre(n));m[j]=new g(!0,o,d.getOpen(n)),m[j+k]=new g(!1,o,d.getClose(n))}m.sort(h);var p=new Array,q=i();for(j=0;j<l;++j){var r=m[j],o=r.v;if(r.isOpen)q.insert(o),d.findNeighbours(o,q);else{q.remove(o);var s=function(b,c){var f=(d.getSize(b.r)+d.getSize(c.r))/2+e;p.push(new a.Constraint(b.v,c.v,f))},t=function(a,b,c){for(var d,e=o[a].iterator();null!==(d=e[a]());)c(d,o),d[b].remove(o)};t("prev","next",function(a,b){return s(a,b)}),t("next","prev",function(a,b){return s(b,a)})}}return console.assert(0===q.size),p}function n(a,b){var c=function(c,d){for(var f,e=b.findIter(a);null!==(f=e[c]());){var g=f.r.overlapX(a.r);if((g<=0||g<=f.r.overlapY(a.r))&&(a[c].insert(f),f[d].insert(a)),g<=0)break}};c("next","prev"),c("prev","next")}function o(a,b){var c=function(c,d){var e=b.findIter(a)[c]();null!==e&&e.r.overlapX(a.r)>0&&(a[c].insert(e),e[d].insert(a))};c("next","prev"),c("prev","next")}function p(a,b){return m(a,b,j,1e-6)}function q(a,b){return m(a,b,k,1e-6)}function r(a){return l(a,j,1e-6)}function s(a){return l(a,k,1e-6)}function t(b){var c=b.map(function(b){return new a.Variable(b.cx())}),d=a.generateXConstraints(b,c),e=new a.Solver(c,d);e.solve(),c.forEach(function(a,c){return b[c].setXCentre(a.position())}),c=b.map(function(b){return new a.Variable(b.cy())}),d=a.generateYConstraints(b,c),e=new a.Solver(c,d),e.solve(),c.forEach(function(a,c){return b[c].setYCentre(a.position())})}a.computeGroupBounds=b;var c=function(){function a(a,b,c,d){this.x=a,this.X=b,this.y=c,this.Y=d}return a.empty=function(){return new a(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY)},a.prototype.cx=function(){return(this.x+this.X)/2},a.prototype.cy=function(){return(this.y+this.Y)/2},a.prototype.overlapX=function(a){var b=this.cx(),c=a.cx();return b<=c&&a.x<this.X?this.X-a.x:c<=b&&this.x<a.X?a.X-this.x:0},a.prototype.overlapY=function(a){var b=this.cy(),c=a.cy();return b<=c&&a.y<this.Y?this.Y-a.y:c<=b&&this.y<a.Y?a.Y-this.y:0},a.prototype.setXCentre=function(a){var b=a-this.cx();this.x+=b,this.X+=b},a.prototype.setYCentre=function(a){var b=a-this.cy();this.y+=b,this.Y+=b},a.prototype.width=function(){return this.X-this.x},a.prototype.height=function(){return this.Y-this.y},a.prototype.union=function(b){return new a(Math.min(this.x,b.x),Math.max(this.X,b.X),Math.min(this.y,b.y),Math.max(this.Y,b.Y))},a.prototype.lineIntersections=function(b,c,d,e){for(var f=[[this.x,this.y,this.X,this.y],[this.X,this.y,this.X,this.Y],[this.X,this.Y,this.x,this.Y],[this.x,this.Y,this.x,this.y]],g=[],h=0;h<4;++h){var i=a.lineIntersection(b,c,d,e,f[h][0],f[h][1],f[h][2],f[h][3]);null!==i&&g.push({x:i.x,y:i.y})}return g},a.prototype.rayIntersection=function(a,b){var c=this.lineIntersections(this.cx(),this.cy(),a,b);return c.length>0?c[0]:null},a.prototype.vertices=function(){return[{x:this.x,y:this.y},{x:this.X,y:this.y},{x:this.X,y:this.Y},{x:this.x,y:this.Y},{x:this.x,y:this.y}]},a.lineIntersection=function(a,b,c,d,e,f,g,h){var i=c-a,j=g-e,k=d-b,l=h-f,m=l*i-j*k;if(0==m)return null;var n=a-e,o=b-f,p=j*o-l*n,q=p/m,r=i*o-k*n,s=r/m;return q>=0&&q<=1&&s>=0&&s<=1?{x:a+q*i,y:b+q*k}:null},a.prototype.inflate=function(b){return new a(this.x-b,this.X+b,this.y-b,this.Y+b)},a}();a.Rectangle=c,a.makeEdgeBetween=d,a.makeEdgeTo=e;var f=function(){function a(a,b,c){this.v=a,this.r=b,this.pos=c,this.prev=i(),this.next=i()}return a}(),g=function(){function a(a,b,c){this.isOpen=a,this.v=b,this.pos=c}return a}(),j={getCentre:function(a){return a.cx()},getOpen:function(a){return a.y},getClose:function(a){return a.Y},getSize:function(a){return a.width()},makeRect:function(a,b,d,e){return new c(d-e/2,d+e/2,a,b)},findNeighbours:n},k={getCentre:function(a){return a.cy()},getOpen:function(a){return a.x},getClose:function(a){return a.X},getSize:function(a){return a.height()},makeRect:function(a,b,d,e){return new c(a,b,d-e/2,d+e/2)},findNeighbours:o};a.generateXConstraints=p,a.generateYConstraints=q,a.generateXGroupConstraints=r,a.generateYGroupConstraints=s,a.removeOverlaps=t;var u=function(a){function b(b,c){a.call(this,0,c),this.index=b}return __extends(b,a),b}(a.Variable);a.IndexedVariable=u;var v=function(){function d(c,d,e,f,g){var h=this;if(void 0===e&&(e=null),void 0===f&&(f=null),void 0===g&&(g=!1),this.nodes=c,this.groups=d,this.rootGroup=e,this.avoidOverlaps=g,this.variables=c.map(function(a,b){return a.variable=new u(b,1)}),f&&this.createConstraints(f),g&&e&&"undefined"!=typeof e.groups){c.forEach(function(b){if(!b.width||!b.height)return void(b.bounds=new a.Rectangle(b.x,b.x,b.y,b.y));var c=b.width/2,d=b.height/2;b.bounds=new a.Rectangle(b.x-c,b.x+c,b.y-d,b.y+d)}),b(e);var i=c.length;d.forEach(function(a){h.variables[i]=a.minVar=new u(i++,"undefined"!=typeof a.stiffness?a.stiffness:.01),h.variables[i]=a.maxVar=new u(i++,"undefined"!=typeof a.stiffness?a.stiffness:.01)})}}return d.prototype.createSeparation=function(b){return new a.Constraint(this.nodes[b.left].variable,this.nodes[b.right].variable,b.gap,"undefined"!=typeof b.equality&&b.equality)},d.prototype.makeFeasible=function(a){var b=this;if(this.avoidOverlaps){var c="x",d="width";"x"===a.axis&&(c="y",d="height");var e=a.offsets.map(function(a){return b.nodes[a.node]}).sort(function(a,b){return a[c]-b[c]}),f=null;e.forEach(function(a){f&&(a[c]=f[c]+f[d]+1),f=a})}},d.prototype.createAlignment=function(b){var c=this,d=this.nodes[b.offsets[0].node].variable;this.makeFeasible(b);var e="x"===b.axis?this.xConstraints:this.yConstraints;b.offsets.slice(1).forEach(function(b){var f=c.nodes[b.node].variable;e.push(new a.Constraint(d,f,b.offset,!0))})},d.prototype.createConstraints=function(a){var b=this,c=function(a){return"undefined"==typeof a.type||"separation"===a.type};this.xConstraints=a.filter(function(a){return"x"===a.axis&&c(a)}).map(function(a){return b.createSeparation(a)}),this.yConstraints=a.filter(function(a){return"y"===a.axis&&c(a)}).map(function(a){return b.createSeparation(a)}),a.filter(function(a){return"alignment"===a.type}).forEach(function(a){return b.createAlignment(a)})},d.prototype.setupVariablesAndBounds=function(a,b,d,e){this.nodes.forEach(function(f,g){f.fixed?(f.variable.weight=1e3,d[g]=e(f)):f.variable.weight=1;var h=(f.width||0)/2,i=(f.height||0)/2,j=a[g],k=b[g];f.bounds=new c(j-h,j+h,k-i,k+i)})},d.prototype.xProject=function(a,b,c){(this.rootGroup||this.avoidOverlaps||this.xConstraints)&&this.project(a,b,a,c,function(a){return a.px},this.xConstraints,r,function(a){return a.bounds.setXCentre(c[a.variable.index]=a.variable.position())},function(a){var b=c[a.minVar.index]=a.minVar.position(),d=c[a.maxVar.index]=a.maxVar.position(),e=a.padding/2;a.bounds.x=b-e,a.bounds.X=d+e})},d.prototype.yProject=function(a,b,c){(this.rootGroup||this.yConstraints)&&this.project(a,b,b,c,function(a){return a.py},this.yConstraints,s,function(a){return a.bounds.setYCentre(c[a.variable.index]=a.variable.position())},function(a){var b=c[a.minVar.index]=a.minVar.position(),d=c[a.maxVar.index]=a.maxVar.position(),e=a.padding/2;a.bounds.y=b-e,a.bounds.Y=d+e})},d.prototype.projectFunctions=function(){var a=this;return[function(b,c,d){return a.xProject(b,c,d)},function(b,c,d){return a.yProject(b,c,d)}]},d.prototype.project=function(a,c,d,e,f,g,h,i,j){this.setupVariablesAndBounds(a,c,e,f),this.rootGroup&&this.avoidOverlaps&&(b(this.rootGroup),g=g.concat(h(this.rootGroup))),this.solve(this.variables,g,d,e),this.nodes.forEach(i),this.rootGroup&&this.avoidOverlaps&&this.groups.forEach(j)},d.prototype.solve=function(b,c,d,e){var f=new a.Solver(b,c);f.setStartingPositions(d),f.setDesiredPositions(e),f.solve()},d}();a.Projection=v}(b=a.vpsc||(a.vpsc={}))}(cola||(cola={}));var cola;!function(a){var b;!function(b){function f(a,b,c){return(b.x-a.x)*(c.y-a.y)-(c.x-a.x)*(b.y-a.y)}function g(a,b,c){return f(a,b,c)>0}function h(a,b,c){return f(a,b,c)<0}function i(a){var d,b=a.slice(0).sort(function(a,b){return a.x!==b.x?b.x-a.x:b.y-a.y}),c=a.length,e=0,g=b[0].x;for(d=1;d<c&&b[d].x===g;++d);var h=d-1,i=[];if(i.push(b[e]),h===c-1)b[h].y!==b[e].y&&i.push(b[h]);else{var j,k=c-1,l=b[c-1].x;for(d=c-2;d>=0&&b[d].x===l;d--);for(j=d+1,d=h;++d<=j;)if(!(f(b[e],b[j],b[d])>=0&&d<j)){for(;i.length>1&&!(f(i[i.length-2],i[i.length-1],b[d])>0);)i.length-=1;d!=e&&i.push(b[d])}k!=j&&i.push(b[k]);var m=i.length;for(d=j;--d>=h;)if(!(f(b[k],b[h],b[d])>=0&&d>h)){for(;i.length>m&&!(f(i[i.length-2],i[i.length-1],b[d])>0);)i.length-=1;d!=e&&i.push(b[d])}}return i}function j(a,b,c){b.slice(0).sort(function(b,c){return Math.atan2(b.y-a.y,b.x-a.x)-Math.atan2(c.y-a.y,c.x-a.x)}).forEach(c)}function m(a,b){return{rtan:n(a,b),ltan:o(a,b)}}function n(a,b){var d,e,f,i,j,c=b.length-1;if(h(a,b[1],b[0])&&!g(a,b[c-1],b[0]))return 0;for(d=0,e=c;;){if(e-d===1)return g(a,b[d],b[e])?d:e;if(f=Math.floor((d+e)/2),j=h(a,b[f+1],b[f]),j&&!g(a,b[f-1],b[f]))return f;i=g(a,b[d+1],b[d]),i?j?e=f:g(a,b[d],b[f])?e=f:d=f:j&&h(a,b[d],b[f])?e=f:d=f}}function o(a,b){var d,e,f,i,j,c=b.length-1;if(g(a,b[c-1],b[0])&&!h(a,b[1],b[0]))return 0;for(d=0,e=c;;){if(e-d===1)return h(a,b[d],b[e])?d:e;if(f=Math.floor((d+e)/2),j=h(a,b[f+1],b[f]),g(a,b[f-1],b[f])&&!j)return f;i=h(a,b[d+1],b[d]),i?j?h(a,b[d],b[f])?e=f:d=f:e=f:j?d=f:g(a,b[d],b[f])?e=f:d=f}}function p(a,b,c,d,e,f){var g,h;g=c(b[0],a),h=d(a[g],b);for(var i=!1;!i;){for(i=!0;;){if(g===a.length-1&&(g=0),e(b[h],a[g],a[g+1]))break;++g}for(;;){if(0===h&&(h=b.length-1),f(a[g],b[h],b[h-1]))break;--h,i=!1}}return{t1:g,t2:h}}function q(a,b){var c=r(b,a);return{t1:c.t2,t2:c.t1}}function r(a,b){return p(a,b,n,o,g,h)}function s(a,b){return p(a,b,o,o,h,h)}function t(a,b){return p(a,b,n,n,g,g)}function A(b,c){for(var d=[],e=1,f=c.length;e<f;++e){var g=a.vpsc.Rectangle.lineIntersection(b.x1,b.y1,b.x2,b.y2,c[e-1].x,c[e-1].y,c[e].x,c[e].y);g&&d.push(g)}return d}function B(a,b){for(var c=a.length-1,d=b.length-1,e=new v,g=0;g<c;++g)for(var h=0;h<d;++h){var i=a[0==g?c-1:g-1],j=a[g],k=a[g+1],l=b[0==h?d-1:h-1],m=b[h],n=b[h+1],o=f(i,j,m),p=f(j,l,m),q=f(j,m,n),r=f(l,m,j),s=f(m,i,j),t=f(m,j,k);o>=0&&p>=0&&q<0&&r>=0&&s>=0&&t<0?e.ll=new u(g,h):o<=0&&p<=0&&q>0&&r<=0&&s<=0&&t>0?e.rr=new u(g,h):o<=0&&p>0&&q<=0&&r>=0&&s<0&&t>=0?e.rl=new u(g,h):o>=0&&p<0&&q>=0&&r<=0&&s>0&&t<=0&&(e.lr=new u(g,h))}return e}function C(a,b){for(var c=1,d=b.length;c<d;++c)if(h(b[c-1],b[c],a))return!1;return!0}function D(a,b){return!a.every(function(a){return!C(a,b)})}function E(a,b){if(D(a,b))return!0;if(D(b,a))return!0;for(var c=1,e=a.length;c<e;++c){var f=a[c],g=a[c-1];if(A(new d(g.x,g.y,f.x,f.y),b).length>0)return!0}return!1}var c=function(){function a(){}return a}();b.Point=c;var d=function(){function a(a,b,c,d){this.x1=a,this.y1=b,this.x2=c,this.y2=d}return a}();b.LineSegment=d;var e=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b}(c);b.PolyPoint=e,b.isLeft=f,b.ConvexHull=i,b.clockwiseRadialSweep=j,b.tangent_PolyPolyC=p,b.LRtangent_PolyPolyC=q,b.RLtangent_PolyPolyC=r,b.LLtangent_PolyPolyC=s,b.RRtangent_PolyPolyC=t;var u=function(){function a(a,b){this.t1=a,this.t2=b}return a}();b.BiTangent=u;var v=function(){function a(){}return a}();b.BiTangents=v;var w=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b}(c);b.TVGPoint=w;var x=function(){function a(a,b,c,d){this.id=a,this.polyid=b,this.polyvertid=c,this.p=d,d.vv=this}return a}();b.VisibilityVertex=x;var y=function(){function a(a,b){this.source=a,this.target=b}return a.prototype.length=function(){var a=this.source.p.x-this.target.p.x,b=this.source.p.y-this.target.p.y;return Math.sqrt(a*a+b*b)},a}();b.VisibilityEdge=y;var z=function(){function a(a,c){if(this.P=a,this.V=[],this.E=[],c)this.V=c.V.slice(0),this.E=c.E.slice(0);else{for(var d=a.length,e=0;e<d;e++)for(var f=a[e],g=0;g<f.length;++g){var h=f[g],i=new x(this.V.length,e,g,h);this.V.push(i),g>0&&this.E.push(new y(f[g-1].vv,i))}for(var e=0;e<d-1;e++)for(var j=a[e],g=e+1;g<d;g++){var k=a[g],l=b.tangents(j,k);for(var m in l){var n=l[m],o=j[n.t1],p=k[n.t2];this.addEdgeIfVisible(o,p,e,g)}}}}return a.prototype.addEdgeIfVisible=function(a,b,c,e){this.intersectsPolys(new d(a.x,a.y,b.x,b.y),c,e)||this.E.push(new y(a.vv,b.vv))},a.prototype.addPoint=function(a,b){var c=this.P.length;this.V.push(new x(this.V.length,c,0,a));for(var d=0;d<c;++d)if(d!==b){var e=this.P[d],f=m(a,e);this.addEdgeIfVisible(a,e[f.ltan],b,d),this.addEdgeIfVisible(a,e[f.rtan],b,d)}return a.vv},a.prototype.intersectsPolys=function(a,b,c){for(var d=0,e=this.P.length;d<e;++d)if(d!=b&&d!=c&&A(a,this.P[d]).length>0)return!0;return!1},a}();b.TangentVisibilityGraph=z,b.tangents=B,b.polysOverlap=E}(b=a.geom||(a.geom={}))}(cola||(cola={}));var cola;!function(a){var b=function(){function a(){this.locks={}}return a.prototype.add=function(a,b){isNaN(b[0])||isNaN(b[1]),this.locks[a]=b},a.prototype.clear=function(){this.locks={}},a.prototype.isEmpty=function(){for(var a in this.locks)return!1;return!0},a.prototype.apply=function(a){for(var b in this.locks)a(b,this.locks[b])},a}();a.Locks=b;var c=function(){function a(a,c,e){void 0===e&&(e=null),this.D=c,this.G=e,this.threshold=1e-4,this.numGridSnapNodes=0,this.snapGridSize=100,this.snapStrength=1e3,this.scaleSnapByMaxH=!1,this.random=new d,this.project=null,this.x=a,this.k=a.length;var f=this.n=a[0].length;this.H=new Array(this.k),this.g=new Array(this.k),this.Hd=new Array(this.k),this.a=new Array(this.k),this.b=new Array(this.k),this.c=new Array(this.k),this.d=new Array(this.k),this.e=new Array(this.k),this.ia=new Array(this.k),this.ib=new Array(this.k),this.xtmp=new Array(this.k),this.locks=new b,this.minD=Number.MAX_VALUE;for(var h,g=f;g--;)for(h=f;--h>g;){var i=c[g][h];i>0&&i<this.minD&&(this.minD=i)}for(this.minD===Number.MAX_VALUE&&(this.minD=1),g=this.k;g--;){for(this.g[g]=new Array(f),this.H[g]=new Array(f),h=f;h--;)this.H[g][h]=new Array(f);this.Hd[g]=new Array(f),this.a[g]=new Array(f),this.b[g]=new Array(f),this.c[g]=new Array(f),this.d[g]=new Array(f),this.e[g]=new Array(f),this.ia[g]=new Array(f),this.ib[g]=new Array(f),this.xtmp[g]=new Array(f)}}return a.createSquareMatrix=function(a,b){for(var c=new Array(a),d=0;d<a;++d){c[d]=new Array(a);for(var e=0;e<a;++e)c[d][e]=b(d,e)}return c},a.prototype.offsetDir=function(){for(var a=this,b=new Array(this.k),c=0,d=0;d<this.k;++d){var e=b[d]=this.random.getNextBetween(.01,1)-.5;c+=e*e}return c=Math.sqrt(c),b.map(function(b){return b*=a.minD/c})},a.prototype.computeDerivatives=function(a){var b=this,c=this.n;if(!(c<1)){for(var d,e=new Array(this.k),f=new Array(this.k),g=new Array(this.k),h=0,i=0;i<c;++i){for(d=0;d<this.k;++d)g[d]=this.g[d][i]=0;for(var j=0;j<c;++j)if(i!==j){for(var k=c;k--;){var l=0;for(d=0;d<this.k;++d){var m=e[d]=a[d][i]-a[d][j];l+=f[d]=m*m}if(l>1e-9)break;var n=this.offsetDir();for(d=0;d<this.k;++d)a[d][j]+=n[d]}var o=Math.sqrt(l),p=this.D[i][j],q=null!=this.G?this.G[i][j]:1;if(q>1&&o>p||!isFinite(p))for(d=0;d<this.k;++d)this.H[d][i][j]=0;else{q>1&&(q=1);var r=p*p,s=q*(o-p)/(r*o),t=-q/(r*o*o*o);for(isFinite(s)||console.log(s),d=0;d<this.k;++d)this.g[d][i]+=e[d]*s,g[d]-=this.H[d][i][j]=t*(p*(f[d]-l)+o*l)}}for(d=0;d<this.k;++d)h=Math.max(h,this.H[d][i][i]=g[d])}for(var u=this.snapGridSize/2,v=this.snapGridSize,w=this.snapStrength,x=w/(u*u),y=this.numGridSnapNodes,i=0;i<y;++i)for(d=0;d<this.k;++d){var z=this.x[d][i],A=z/v,B=A%1,C=A-B,D=Math.abs(B),m=D<=.5?z-C*v:z>0?z-(C+1)*v:z-(C-1)*v;-u<m&&m<=u&&(this.scaleSnapByMaxH?(this.g[d][i]+=h*x*m,this.H[d][i][i]+=h*x):(this.g[d][i]+=x*m,this.H[d][i][i]+=x))}this.locks.isEmpty()||this.locks.apply(function(c,e){for(d=0;d<b.k;++d)b.H[d][c][c]+=h,b.g[d][c]-=h*(e[d]-a[d][c])})}},a.dotProd=function(a,b){for(var c=0,d=a.length;d--;)c+=a[d]*b[d];return c},a.rightMultiply=function(b,c,d){for(var e=b.length;e--;)d[e]=a.dotProd(b[e],c)},a.prototype.computeStepSize=function(b){for(var c=0,d=0,e=0;e<2;++e)c+=a.dotProd(this.g[e],b[e]),a.rightMultiply(this.H[e],b[e],this.Hd[e]),d+=a.dotProd(b[e],this.Hd[e]);return 0!==d&&isFinite(d)?c/d:0},a.prototype.reduceStress=function(){this.computeDerivatives(this.x);for(var a=this.computeStepSize(this.g),b=0;b<this.k;++b)this.takeDescentStep(this.x[b],this.g[b],a);return this.computeStress()},a.copy=function(a,b){for(var c=a.length,d=b[0].length,e=0;e<c;++e)for(var f=0;f<d;++f)b[e][f]=a[e][f]},a.prototype.stepAndProject=function(b,c,d,e){a.copy(b,c),this.takeDescentStep(c[0],d[0],e),this.project&&this.project[0](b[0],b[1],c[0]),this.takeDescentStep(c[1],d[1],e),this.project&&this.project[1](c[0],b[1],c[1])},a.mApply=function(a,b,c){for(var d=a;d-- >0;)for(var e=b;e-- >0;)c(d,e)},a.prototype.matrixApply=function(b){a.mApply(this.k,this.n,b)},a.prototype.computeNextPosition=function(a,b){var c=this;this.computeDerivatives(a);var d=this.computeStepSize(this.g);this.stepAndProject(a,b,this.g,d);for(var e=0;e<this.n;++e)for(var f=0;f<this.k;++f)isNaN(b[f][e]);if(this.project){this.matrixApply(function(d,e){return c.e[d][e]=a[d][e]-b[d][e]});var g=this.computeStepSize(this.e);g=Math.max(.2,Math.min(g,1)),this.stepAndProject(a,b,this.e,g)}},a.prototype.run=function(a){for(var b=Number.MAX_VALUE,c=!1;!c&&a-- >0;){var d=this.rungeKutta();c=Math.abs(b/d-1)<this.threshold,b=d}return b},a.prototype.rungeKutta=function(){var b=this;this.computeNextPosition(this.x,this.a),a.mid(this.x,this.a,this.ia),this.computeNextPosition(this.ia,this.b),a.mid(this.x,this.b,this.ib),this.computeNextPosition(this.ib,this.c),this.computeNextPosition(this.c,this.d);var c=0;return this.matrixApply(function(a,d){var e=(b.a[a][d]+2*b.b[a][d]+2*b.c[a][d]+b.d[a][d])/6,f=b.x[a][d]-e;c+=f*f,b.x[a][d]=e}),c},a.mid=function(b,c,d){a.mApply(b.length,b[0].length,function(a,e){return d[a][e]=b[a][e]+(c[a][e]-b[a][e])/2})},a.prototype.takeDescentStep=function(a,b,c){for(var d=0;d<this.n;++d)a[d]=a[d]-c*b[d]},a.prototype.computeStress=function(){for(var a=0,b=0,c=this.n-1;b<c;++b)for(var d=b+1,e=this.n;d<e;++d){for(var f=0,g=0;g<this.k;++g){var h=this.x[g][b]-this.x[g][d];f+=h*h}f=Math.sqrt(f);var i=this.D[b][d];if(isFinite(i)){var j=i-f,k=i*i;a+=j*j/k}}return a},a.zeroDistance=1e-10,a}();a.Descent=c;var d=function(){function a(a){void 0===a&&(a=1),this.seed=a,this.a=214013,this.c=2531011,this.m=2147483648,this.range=32767}return a.prototype.getNext=function(){return this.seed=(this.seed*this.a+this.c)%this.m,(this.seed>>16)/this.range},a.prototype.getNextBetween=function(a,b){return a+this.getNext()*(b-a)},a}();a.PseudoRandom=d}(cola||(cola={}));var cola;!function(a){var b;!function(a){function d(a,b,c){a.forAll(function(a){if(a.isLeaf())b.leaves||(b.leaves=[]),b.leaves.push(a.id);else{var e=b;if(a.gid=c.length,!a.isIsland()||a.isPredefined()){if(e={id:a.gid},a.isPredefined())for(var f in a.definition)e[f]=a.definition[f];b.groups||(b.groups=[]),b.groups.push(a.gid),c.push(e)}d(a.children,e,c)}})}function f(a,b){var c={};for(var d in a)d in b&&(c[d]=a[d]);return c}function j(b,c,d,e){for(var f=b.length,g=new a.Configuration(f,c,d,e);g.greedyMerge(););var h=[],i=g.getGroupHierarchy(h);return h.forEach(function(a){var c=function(c){var d=a[c];"number"==typeof d&&(a[c]=b[d])};c("source"),c("target")}),{groups:i,powerEdges:h}}var b=function(){function a(a,b,c){this.source=a,this.target=b,this.type=c}return a}();a.PowerEdge=b;var c=function(){function a(a,b,c,d){var f=this;if(this.linkAccessor=c,this.modules=new Array(a),this.roots=[],d)this.initModulesFromGroup(d);else{this.roots.push(new g);for(var h=0;h<a;++h)this.roots[0].add(this.modules[h]=new e(h))}this.R=b.length,b.forEach(function(a){var b=f.modules[c.getSourceIndex(a)],d=f.modules[c.getTargetIndex(a)],e=c.getType(a);b.outgoing.add(e,d),d.incoming.add(e,b)})}return a.prototype.initModulesFromGroup=function(a){var b=new g;this.roots.push(b);for(var c=0;c<a.leaves.length;++c){var d=a.leaves[c],f=new e(d.id);this.modules[d.id]=f,b.add(f)}if(a.groups)for(var i=0;i<a.groups.length;++i){var j=a.groups[i],k={};for(var l in j)"leaves"!==l&&"groups"!==l&&j.hasOwnProperty(l)&&(k[l]=j[l]);b.add(new e(-1-i,new h,new h,this.initModulesFromGroup(j),k))}return b},a.prototype.merge=function(a,b,c){void 0===c&&(c=0);var d=a.incoming.intersection(b.incoming),f=a.outgoing.intersection(b.outgoing),h=new g;h.add(a),h.add(b);var i=new e(this.modules.length,f,d,h);this.modules.push(i);var j=function(c,d,e){c.forAll(function(c,f){c.forAll(function(c){var g=c[d];g.add(f,i),g.remove(f,a),g.remove(f,b),a[e].remove(f,c),b[e].remove(f,c)})})};return j(f,"incoming","outgoing"),j(d,"outgoing","incoming"),this.R-=d.count()+f.count(),this.roots[c].remove(a),this.roots[c].remove(b),this.roots[c].add(i),i},a.prototype.rootMerges=function(a){void 0===a&&(a=0);for(var b=this.roots[a].modules(),c=b.length,d=new Array(c*(c-1)),e=0,f=0,g=c-1;f<g;++f)for(var h=f+1;h<c;++h){var i=b[f],j=b[h];d[e++]={nEdges:this.nEdges(i,j),a:i,b:j}}return d},a.prototype.greedyMerge=function(){for(var a=0;a<this.roots.length;++a)if(!(this.roots[a].modules().length<2)){var b=this.rootMerges(a).sort(function(a,b){return a.nEdges-b.nEdges}),c=b[0];if(!(c.nEdges>=this.R))return this.merge(c.a,c.b,a),!0}},a.prototype.nEdges=function(a,b){var c=a.incoming.intersection(b.incoming),d=a.outgoing.intersection(b.outgoing);return this.R-c.count()-d.count()},a.prototype.getGroupHierarchy=function(a){var c=this,e=[],f={};d(this.roots[0],f,e);var g=this.allEdges();return g.forEach(function(d){var f=c.modules[d.source],g=c.modules[d.target];a.push(new b("undefined"==typeof f.gid?d.source:e[f.gid],"undefined"==typeof g.gid?d.target:e[g.gid],d.type))}),e},a.prototype.allEdges=function(){var b=[];return a.getEdges(this.roots[0],b),b},a.getEdges=function(b,c){b.forAll(function(b){b.getEdges(c),a.getEdges(b.children,c)})},a}();a.Configuration=c;var e=function(){function a(a,b,c,d,e){void 0===b&&(b=new h),void 0===c&&(c=new h),void 0===d&&(d=new g),this.id=a,this.outgoing=b,this.incoming=c,this.children=d,this.definition=e}return a.prototype.getEdges=function(a){var c=this;this.outgoing.forAll(function(d,e){d.forAll(function(d){a.push(new b(c.id,d.id,e))})})},a.prototype.isLeaf=function(){return 0===this.children.count()},a.prototype.isIsland=function(){return 0===this.outgoing.count()&&0===this.incoming.count()},a.prototype.isPredefined=function(){return"undefined"!=typeof this.definition},a}();a.Module=e;var g=function(){function a(){this.table={}}return a.prototype.count=function(){return Object.keys(this.table).length},a.prototype.intersection=function(b){var c=new a;return c.table=f(this.table,b.table),c},a.prototype.intersectionCount=function(a){return this.intersection(a).count()},a.prototype.contains=function(a){return a in this.table},a.prototype.add=function(a){this.table[a.id]=a},a.prototype.remove=function(a){delete this.table[a.id]},a.prototype.forAll=function(a){for(var b in this.table)a(this.table[b])},a.prototype.modules=function(){var a=[];return this.forAll(function(b){b.isPredefined()||a.push(b)}),a},a}();a.ModuleSet=g;var h=function(){function a(){this.sets={},this.n=0}return a.prototype.count=function(){return this.n},a.prototype.contains=function(a){var b=!1;return this.forAllModules(function(c){b||c.id!=a||(b=!0)}),b},a.prototype.add=function(a,b){var c=a in this.sets?this.sets[a]:this.sets[a]=new g;c.add(b),++this.n},a.prototype.remove=function(a,b){var c=this.sets[a];c.remove(b),0===c.count()&&delete this.sets[a],--this.n},a.prototype.forAll=function(a){for(var b in this.sets)a(this.sets[b],b)},a.prototype.forAllModules=function(a){this.forAll(function(b,c){return b.forAll(a)})},a.prototype.intersection=function(b){var c=new a;return this.forAll(function(a,d){if(d in b.sets){var e=a.intersection(b.sets[d]),f=e.count();f>0&&(c.sets[d]=e,c.n+=f)}}),c},a}();a.LinkSets=h,a.getGroups=j}(b=a.powergraph||(a.powergraph={}))}(cola||(cola={}));var cola;!function(a){function b(a,b){var c={};for(var d in a)c[d]={};for(var d in b)c[d]={};return Object.keys(c).length}function c(a,b){var c=0;for(var d in a)"undefined"!=typeof b[d]&&++c;return c}function d(a,b){var c={},d=function(a,b){"undefined"==typeof c[a]&&(c[a]={}),c[a][b]={}};return a.forEach(function(a){var c=b.getSourceIndex(a),e=b.getTargetIndex(a);d(c,e),d(e,c)}),c}function e(a,b,c,e){var f=d(a,e);a.forEach(function(a){var d=f[e.getSourceIndex(a)],g=f[e.getTargetIndex(a)];e.setLength(a,1+b*c(d,g))})}function f(a,d,f){void 0===f&&(f=1),e(a,f,function(a,d){return Math.sqrt(b(a,d)-c(a,d))},d)}function g(a,d,f){void 0===f&&(f=1),e(a,f,function(a,d){return Math.min(Object.keys(a).length,Object.keys(d).length)<1.1?0:c(a,d)/b(a,d)},d)}function h(a,b,c,d){var e=i(a,b,d),f={};e.filter(function(a){return a.length>1}).forEach(function(a){return a.forEach(function(b){return f[b]=a})});var g=[];return b.forEach(function(a){var b=d.getSourceIndex(a),e=d.getTargetIndex(a),h=f[b],i=f[e];h&&i&&h.component===i.component||g.push({axis:c,left:b,right:e,gap:d.getMinSeparation(a)})}),g}function i(a,b,c){function l(a){e[a]=i,f[a]=i,g[a]=!0,i+=1,j.push(a);for(var b=d[a],c=0;c<b.length;++c){var h=b[c];e[h]<0?(l(h),f[a]=0|Math.min(f[a],f[h])):g[h]&&(f[a]=Math.min(f[a],f[h]))}if(f[a]===e[a]){for(var m=[],c=j.length-1;c>=0;--c){var n=j[c];if(g[n]=!1,m.push(n),n===a){j.length=c;break}}k.push(m)}}for(var d=new Array(a),e=new Array(a),f=new Array(a),g=new Array(a),h=0;h<a;++h)d[h]=[],e[h]=-1,f[h]=0,g[h]=!1;for(var h=0;h<b.length;++h)d[c.getSourceIndex(b[h])].push(c.getTargetIndex(b[h]));for(var i=0,j=[],k=[],h=0;h<a;++h)e[h]<0&&l(h);return k}a.symmetricDiffLinkLengths=f,a.jaccardLinkLengths=g,a.generateDirectedEdgeConstraints=h}(cola||(cola={}));var PairingHeap=function(){function a(a){this.elem=a,this.subheaps=[]}return a.prototype.toString=function(a){for(var b="",c=!1,d=0;d<this.subheaps.length;++d){var e=this.subheaps[d];e.elem?(c&&(b+=","),b+=e.toString(a),c=!0):c=!1}return""!==b&&(b="("+b+")"),(this.elem?a(this.elem):"")+b},a.prototype.forEach=function(a){this.empty()||(a(this.elem,this),this.subheaps.forEach(function(b){return b.forEach(a)}))},a.prototype.count=function(){return this.empty()?0:1+this.subheaps.reduce(function(a,b){return a+b.count()},0)},a.prototype.min=function(){return this.elem},a.prototype.empty=function(){return null==this.elem},a.prototype.contains=function(a){if(this===a)return!0;for(var b=0;b<this.subheaps.length;b++)if(this.subheaps[b].contains(a))return!0;return!1},a.prototype.isHeap=function(a){var b=this;return this.subheaps.every(function(c){return a(b.elem,c.elem)&&c.isHeap(a)})},a.prototype.insert=function(b,c){return this.merge(new a(b),c)},a.prototype.merge=function(a,b){return this.empty()?a:a.empty()?this:b(this.elem,a.elem)?(this.subheaps.push(a),this):(a.subheaps.push(this),a)},a.prototype.removeMin=function(a){return this.empty()?null:this.mergePairs(a)},a.prototype.mergePairs=function(b){if(0==this.subheaps.length)return new a(null);if(1==this.subheaps.length)return this.subheaps[0];var c=this.subheaps.pop().merge(this.subheaps.pop(),b),d=this.mergePairs(b);return c.merge(d,b)},a.prototype.decreaseKey=function(b,c,d,e){var f=b.removeMin(e);b.elem=f.elem,b.subheaps=f.subheaps,null!==d&&null!==f.elem&&d(b.elem,b);var g=new a(c);return null!==d&&d(c,g),this.merge(g,e)},a}(),PriorityQueue=function(){function a(a){this.lessThan=a}return a.prototype.top=function(){return this.empty()?null:this.root.elem},a.prototype.push=function(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];for(var c,e,d=0;e=a[d];++d)c=new PairingHeap(e),this.root=this.empty()?c:this.root.merge(c,this.lessThan);return c},a.prototype.empty=function(){return!this.root||!this.root.elem},a.prototype.isHeap=function(){return this.root.isHeap(this.lessThan)},a.prototype.forEach=function(a){this.root.forEach(a)},a.prototype.pop=function(){if(this.empty())return null;var a=this.root.min();return this.root=this.root.removeMin(this.lessThan),a},a.prototype.reduceKey=function(a,b,c){void 0===c&&(c=null),this.root=this.root.decreaseKey(a,b,c,this.lessThan)},a.prototype.toString=function(a){return this.root.toString(a)},a.prototype.count=function(){return this.root.count()},a}(),cola;!function(a){var b;!function(a){var b=function(){function a(a,b){this.id=a,this.distance=b}return a}(),c=function(){function a(a){this.id=a,this.neighbours=[]}return a}(),d=function(){function a(a,b,c){this.node=a,this.prev=b,this.d=c}return a}(),e=function(){function a(a,d,e,f,g){this.n=a,this.es=d,this.neighbours=new Array(this.n);for(var h=this.n;h--;)this.neighbours[h]=new c(h);for(h=this.es.length;h--;){var i=this.es[h],j=e(i),k=f(i),l=g(i);this.neighbours[j].neighbours.push(new b(k,l)),this.neighbours[k].neighbours.push(new b(j,l))}}return a.prototype.DistanceMatrix=function(){for(var a=new Array(this.n),b=0;b<this.n;++b)a[b]=this.dijkstraNeighbours(b);return a},a.prototype.DistancesFromNode=function(a){return this.dijkstraNeighbours(a)},a.prototype.PathFromNodeToNode=function(a,b){return this.dijkstraNeighbours(a,b)},a.prototype.PathFromNodeToNodeWithPrevCost=function(a,b,c){var e=new PriorityQueue(function(a,b){return a.d<=b.d}),f=this.neighbours[a],g=new d(f,null,0),h={};for(e.push(g);!e.empty()&&(g=e.pop(),f=g.node,f.id!==b);)for(var i=f.neighbours.length;i--;){var j=f.neighbours[i],k=this.neighbours[j.id];if(!g.prev||k.id!==g.prev.node.id){var l=k.id+","+f.id;if(!(l in h&&h[l]<=g.d)){var m=g.prev?c(g.prev.node.id,f.id,k.id):0,n=g.d+j.distance+m;h[l]=n,e.push(new d(k,g,n))}}}for(var o=[];g.prev;)g=g.prev,o.push(g.node.id);return o},a.prototype.dijkstraNeighbours=function(a,b){void 0===b&&(b=-1);for(var c=new PriorityQueue(function(a,b){return a.d<=b.d}),d=this.neighbours.length,e=new Array(d);d--;){var f=this.neighbours[d];f.d=d===a?0:Number.POSITIVE_INFINITY,f.q=c.push(f)}for(;!c.empty();){var g=c.pop();if(e[g.id]=g.d,g.id===b){for(var h=[],i=g;"undefined"!=typeof i.prev;)h.push(i.prev.id),i=i.prev;return h}for(d=g.neighbours.length;d--;){var j=g.neighbours[d],i=this.neighbours[j.id],k=g.d+j.distance;g.d!==Number.MAX_VALUE&&i.d>k&&(i.d=k,i.prev=g,c.reduceKey(i.q,i,function(a,b){return a.q=b}))}}return e},a}();a.Calculator=e}(b=a.shortestpaths||(a.shortestpaths={}))}(cola||(cola={}));var cola;!function(a){!function(a){a[a.start=0]="start",a[a.tick=1]="tick",a[a.end=2]="end"}(a.EventType||(a.EventType={}));var b=a.EventType,c=function(){function c(){this._canvasSize=[1,1],this._linkDistance=20,this._defaultNodeSize=10,this._linkLengthCalculator=null,this._linkType=null,this._avoidOverlaps=!1,this._handleDisconnected=!0,this._running=!1,this._nodes=[],this._groups=[],this._variables=[],this._rootGroup=null,this._links=[],this._constraints=[],this._distanceMatrix=null,this._descent=null,this._directedLinkConstraints=null,this._threshold=.01,this._visibilityGraph=null,this._groupCompactness=1e-6,this.event=null,this.linkAccessor={getSourceIndex:c.getSourceIndex,getTargetIndex:c.getTargetIndex,setLength:c.setLinkLength,getType:this.getLinkType}}return c.prototype.on=function(a,c){return this.event||(this.event={}),"string"==typeof a?this.event[b[a]]=c:this.event[a]=c,this},c.prototype.trigger=function(a){this.event&&"undefined"!=typeof this.event[a.type]&&this.event[a.type](a)},c.prototype.kick=function(){for(;!this.tick(););},c.prototype.tick=function(){if(this._alpha<this._threshold)return this._running=!1,this.trigger({type:b.end,alpha:this._alpha=0,stress:this._lastStress}),!0;var d,a=this._nodes.length;this._links.length;this._descent.locks.clear();for(var e=0;e<a;++e)if(d=this._nodes[e],d.fixed){"undefined"!=typeof d.px&&"undefined"!=typeof d.py||(d.px=d.x,d.py=d.y);var f=[d.px,d.py];this._descent.locks.add(e,f)}var g=this._descent.rungeKutta();0===g?this._alpha=0:"undefined"!=typeof this._lastStress&&(this._alpha=g),this._lastStress=g;for(var e=0;e<a;++e)d=this._nodes[e],d.fixed?(d.x=d.px,d.y=d.py):(d.x=this._descent.x[0][e],
d.y=this._descent.x[1][e]);return this.trigger({type:b.tick,alpha:this._alpha,stress:this._lastStress}),!1},c.prototype.nodes=function(a){if(!a){if(0===this._nodes.length&&this._links.length>0){var b=0;this._links.forEach(function(a){b=Math.max(b,a.source,a.target)}),this._nodes=new Array(++b);for(var c=0;c<b;++c)this._nodes[c]={}}return this._nodes}return this._nodes=a,this},c.prototype.groups=function(a){var b=this;return a?(this._groups=a,this._rootGroup={},this._groups.forEach(function(a){"undefined"==typeof a.padding&&(a.padding=1),"undefined"!=typeof a.leaves&&a.leaves.forEach(function(c,d){(a.leaves[d]=b._nodes[c]).parent=a}),"undefined"!=typeof a.groups&&a.groups.forEach(function(c,d){(a.groups[d]=b._groups[c]).parent=a})}),this._rootGroup.leaves=this._nodes.filter(function(a){return"undefined"==typeof a.parent}),this._rootGroup.groups=this._groups.filter(function(a){return"undefined"==typeof a.parent}),this):this._groups},c.prototype.powerGraphGroups=function(b){var c=a.powergraph.getGroups(this._nodes,this._links,this.linkAccessor,this._rootGroup);return this.groups(c.groups),b(c),this},c.prototype.avoidOverlaps=function(a){return arguments.length?(this._avoidOverlaps=a,this):this._avoidOverlaps},c.prototype.handleDisconnected=function(a){return arguments.length?(this._handleDisconnected=a,this):this._handleDisconnected},c.prototype.flowLayout=function(a,b){return arguments.length||(a="y"),this._directedLinkConstraints={axis:a,getMinSeparation:"number"==typeof b?function(){return b}:b},this},c.prototype.links=function(a){return arguments.length?(this._links=a,this):this._links},c.prototype.constraints=function(a){return arguments.length?(this._constraints=a,this):this._constraints},c.prototype.distanceMatrix=function(a){return arguments.length?(this._distanceMatrix=a,this):this._distanceMatrix},c.prototype.size=function(a){return a?(this._canvasSize=a,this):this._canvasSize},c.prototype.defaultNodeSize=function(a){return a?(this._defaultNodeSize=a,this):this._defaultNodeSize},c.prototype.groupCompactness=function(a){return a?(this._groupCompactness=a,this):this._groupCompactness},c.prototype.linkDistance=function(a){return a?(this._linkDistance="function"==typeof a?a:+a,this._linkLengthCalculator=null,this):this._linkDistance},c.prototype.linkType=function(a){return this._linkType=a,this},c.prototype.convergenceThreshold=function(a){return a?(this._threshold="function"==typeof a?a:+a,this):this._threshold},c.prototype.alpha=function(a){return arguments.length?(a=+a,this._alpha?a>0?this._alpha=a:this._alpha=0:a>0&&(this._running||(this._running=!0,this.trigger({type:b.start,alpha:this._alpha=a}),this.kick())),this):this._alpha},c.prototype.getLinkLength=function(a){return"function"==typeof this._linkDistance?+this._linkDistance(a):this._linkDistance},c.setLinkLength=function(a,b){a.length=b},c.prototype.getLinkType=function(a){return"function"==typeof this._linkType?this._linkType(a):0},c.prototype.symmetricDiffLinkLengths=function(b,c){var d=this;return this.linkDistance(function(a){return b*a.length}),this._linkLengthCalculator=function(){return a.symmetricDiffLinkLengths(d._links,d.linkAccessor,c)},this},c.prototype.jaccardLinkLengths=function(b,c){var d=this;return this.linkDistance(function(a){return b*a.length}),this._linkLengthCalculator=function(){return a.jaccardLinkLengths(d._links,d.linkAccessor,c)},this},c.prototype.start=function(b,d,e,f){var g=this;void 0===b&&(b=0),void 0===d&&(d=0),void 0===e&&(e=0),void 0===f&&(f=0);var h,j=this.nodes().length,k=j+2*this._groups.length,m=(this._links.length,this._canvasSize[0]),n=this._canvasSize[1];this._linkLengthCalculator&&this._linkLengthCalculator();var o=new Array(k),p=new Array(k);this._variables=new Array(k);var r=null,s=this._avoidOverlaps;this._nodes.forEach(function(a,b){a.index=b,"undefined"==typeof a.x&&(a.x=m/2,a.y=n/2),o[b]=a.x,p[b]=a.y});var t;this._distanceMatrix?t=this._distanceMatrix:(t=new a.shortestpaths.Calculator(k,this._links,c.getSourceIndex,c.getTargetIndex,function(a){return g.getLinkLength(a)}).DistanceMatrix(),r=a.Descent.createSquareMatrix(k,function(){return 2}),this._links.forEach(function(a){var b=c.getSourceIndex(a),d=c.getTargetIndex(a);r[b][d]=r[d][b]=1}));var u=a.Descent.createSquareMatrix(k,function(a,b){return t[a][b]});if(this._rootGroup&&"undefined"!=typeof this._rootGroup.groups){var h=j,v=function(a,b,c,d){r[a][b]=r[b][a]=c,u[a][b]=u[b][a]=d};this._groups.forEach(function(a){v(h,h+1,g._groupCompactness,.1),o[h]=0,p[h++]=0,o[h]=0,p[h++]=0})}else this._rootGroup={leaves:this._nodes,groups:[]};var w=this._constraints||[];this._directedLinkConstraints&&(this.linkAccessor.getMinSeparation=this._directedLinkConstraints.getMinSeparation,w=w.concat(a.generateDirectedEdgeConstraints(j,this._links,this._directedLinkConstraints.axis,this.linkAccessor))),this.avoidOverlaps(!1),this._descent=new a.Descent([o,p],u),this._descent.locks.clear();for(var h=0;h<j;++h){var x=this._nodes[h];if(x.fixed){x.px=x.x,x.py=x.y;var y=[x.x,x.y];this._descent.locks.add(h,y)}}if(this._descent.threshold=this._threshold,this._descent.run(b),w.length>0&&(this._descent.project=new a.vpsc.Projection(this._nodes,this._groups,this._rootGroup,w).projectFunctions()),this._descent.run(d),this.avoidOverlaps(s),s&&(this._nodes.forEach(function(a,b){a.x=o[b],a.y=p[b]}),this._descent.project=new a.vpsc.Projection(this._nodes,this._groups,this._rootGroup,w,!0).projectFunctions(),this._nodes.forEach(function(a,b){o[b]=a.x,p[b]=a.y})),this._descent.G=r,this._descent.run(e),f){this._descent.snapStrength=1e3,this._descent.snapGridSize=this._nodes[0].width,this._descent.numGridSnapNodes=j,this._descent.scaleSnapByMaxH=!0;var z=a.Descent.createSquareMatrix(k,function(a,b){return a>=j||b>=j?r[a][b]:0});this._descent.G=z,this._descent.run(f)}if(this._links.forEach(function(a){"number"==typeof a.source&&(a.source=g._nodes[a.source]),"number"==typeof a.target&&(a.target=g._nodes[a.target])}),this._nodes.forEach(function(a,b){a.x=o[b],a.y=p[b]}),!this._distanceMatrix&&this._handleDisconnected){var A=a.separateGraphs(this._nodes,this._links);a.applyPacking(A,m,n,this._defaultNodeSize),this._nodes.forEach(function(a,b){g._descent.x[0][b]=a.x,g._descent.x[1][b]=a.y})}return this.resume()},c.prototype.resume=function(){return this.alpha(.1)},c.prototype.stop=function(){return this.alpha(0)},c.prototype.prepareEdgeRouting=function(b){this._visibilityGraph=new a.geom.TangentVisibilityGraph(this._nodes.map(function(a){return a.bounds.inflate(-b).vertices()}))},c.prototype.routeEdge=function(b,c){var d=[],e=new a.geom.TangentVisibilityGraph(this._visibilityGraph.P,{V:this._visibilityGraph.V,E:this._visibilityGraph.E}),f={x:b.source.x,y:b.source.y},g={x:b.target.x,y:b.target.y},h=e.addPoint(f,b.source.id),i=e.addPoint(g,b.target.id);e.addEdgeIfVisible(f,g,b.source.id,b.target.id),"undefined"!=typeof c&&c(e);var j=function(a){return a.source.id},k=function(a){return a.target.id},l=function(a){return a.length()},m=new a.shortestpaths.Calculator(e.V.length,e.E,j,k,l),n=m.PathFromNodeToNode(h.id,i.id);if(1===n.length||n.length===e.V.length)a.vpsc.makeEdgeBetween(b,b.source.innerBounds,b.target.innerBounds,5),d=[{x:b.sourceIntersection.x,y:b.sourceIntersection.y},{x:b.arrowStart.x,y:b.arrowStart.y}];else{for(var o=n.length-2,p=e.V[n[o]].p,q=e.V[n[0]].p,d=[b.source.innerBounds.rayIntersection(p.x,p.y)],r=o;r>=0;--r)d.push(e.V[n[r]].p);d.push(a.vpsc.makeEdgeTo(q,b.target.innerBounds,5))}return d},c.getSourceIndex=function(a){return"number"==typeof a.source?a.source:a.source.index},c.getTargetIndex=function(a){return"number"==typeof a.target?a.target:a.target.index},c.linkId=function(a){return c.getSourceIndex(a)+"-"+c.getTargetIndex(a)},c.dragStart=function(a){a.fixed|=2,a.px=a.x,a.py=a.y},c.dragEnd=function(a){a.fixed&=-7},c.mouseOver=function(a){a.fixed|=4,a.px=a.x,a.py=a.y},c.mouseOut=function(a){a.fixed&=-5},c}();a.Layout=c}(cola||(cola={}));var cola;!function(a){function c(){return new b}var b=function(b){function c(){b.call(this),this.event=d3.dispatch(a.EventType[a.EventType.start],a.EventType[a.EventType.tick],a.EventType[a.EventType.end]);var c=this;this.drag=function(){var b=d3.behavior.drag().origin(function(a){return a}).on("dragstart.d3adaptor",a.Layout.dragStart).on("drag.d3adaptor",function(a){a.px=d3.event.x,a.py=d3.event.y,c.resume()}).on("dragend.d3adaptor",a.Layout.dragEnd);return arguments.length?void this.call(b):b}}return __extends(c,b),c.prototype.trigger=function(b){var c={type:a.EventType[b.type],alpha:b.alpha,stress:b.stress};this.event[c.type](c)},c.prototype.kick=function(){var a=this;d3.timer(function(){return b.prototype.tick.call(a)})},c.prototype.on=function(b,c){return"string"==typeof b?this.event.on(b,c):this.event.on(a.EventType[b],c),this},c}(a.Layout);a.D3StyleLayoutAdaptor=b,a.d3adaptor=c}(cola||(cola={}));var ConfluentGraph=function(){function a(a,b,c){this.labelNodes=[],this.labelLinks=[],this.webGL_nodes=[],this.webGL_label=[],this.d3cola=cola.d3adaptor().avoidOverlaps(!1).linkDistance(150),this.tube=[],this.curveSplines=[],this.number_particles=3,this.number_paths_particule=1,this.number_max_gates=10,this.links_opacity=1,this.tube_width=1,this.needUpdate=!0,this.links=b,this.nodes=a,this.scene=c,this.load_vertex_shaders(),this.load_fragment_shaders(),this.create()}return a.prototype.draw_map=function(a){var b=[],c=this;d3.json("./data/us.json",function(d,e){for(var f=topojson.feature(e,e.objects.land),g=f.geometry.coordinates,h=0;h<g.length;h++){b=[];for(var i=0;i<g[h].length;i++)for(var j=g[h][i],k=1;k<j.length-1;k++){var l=j[k][0],m=j[k][1],n=a([l,m]),o=new THREE.Vector2(n[0],-n[1]);b.push(o)}var p=new THREE.SplineCurve(b),q=new THREE.Shape(p.getSpacedPoints(150)),r=new THREE.ShapeGeometry(q),s=new THREE.MeshLambertMaterial({color:3447003,opacity:.1,transparent:!0}),t=new THREE.Mesh(r,s);c.scene.add(t)}})},a.prototype.create=function(){this.d3cola.nodes(this.nodes).links(this.links).start(),console.log("DEBUT"),this.createLabel(),this.createNodes()},a.prototype.launch_network=function(a,b){var c=this;d3.select("#spinner").style("display","block"),d3.select("#number_nodes").append("h1").text(this.links.length+" Links & "+this.nodes.length+" Nodes"),window.setTimeout(function(){c.d3cola.stop(),c.createTube(),c.createLinks(),b(),c.updateNodes(),c.updateLabel(),c.updateLinks(),c.updateTube(),c.createParticle(),d3.select("#spinner").style("display","none"),c.needUpdate=!1,console.log(c.nodes),console.log(c.links),console.log(c.scene)},a)},a.prototype.create_gates=function(a,b,c,d,e,f){var g=new THREE.LineBasicMaterial({color:255,linewidth:3,opacity:1,transparent:!0});g.opacity=.4;var h=new THREE.Geometry;h.vertices.push(new THREE.Vector3(c,d,0)),h.vertices.push(new THREE.Vector3(e,f,0));var i=new THREE.Line(h,g);this.links[a].gates.length;this.links[a].gates.push({object:i,position:b});var k=this.links[a].gate_infos;k.splice(k.length-1,0,{factor:1,position:b}),this.scene.add(i)},a.prototype.createLabel=function(){var a=this,b=new THREE.FontLoader;b.load("font/helvetiker_bold.typeface.json",function(b){console.log(a.nodes);for(var c=0;c<a.nodes.length;c++){var d=new THREE.TextGeometry(a.nodes[c].attr("label"),{font:b,size:5,height:5,curveSegments:12,bevelThickness:1,bevelSize:5,bevelEnabled:!1}),e=new THREE.MeshPhongMaterial({color:16711680}),f=new THREE.Mesh(d,e);a.webGL_label.push(f),f.position.set(50*c,10,1),f.name="label",console.log("CREATE"),a.scene.add(f)}})},a.prototype.createNodes=function(){console.log(this.scene);for(var b=0;b<this.webGL_nodes.length;b++)this.scene.remove(this.webGL_nodes[b]);this.webGL_nodes=[];for(var b=0;b<this.nodes.length;b++){var c=new THREE.MeshBasicMaterial({color:255,transparent:!0}),d=50,e=new THREE.CircleGeometry(1,d),f=new THREE.Mesh(e,c);this.webGL_nodes.push(f),f.scale.set(1,1,1),f.name="circle",f.userData={id:this.nodes[b]._id,type:"node"},this.scene.add(f)}},a.prototype.updateNode_color=function(a,b,c){this.webGL_nodes[a].material.color=b,this.webGL_nodes[a].scale.set(c,c,c)},a.prototype.update_values=function(){this.updateNodes(),this.updateLabel(),this.updateLinks(),this.updateTube()},a.prototype.update=function(){1==this.needUpdate||this.updateParticle()},a.prototype.createParticle=function(){for(var a=0;a<this.links.length;a++)this.createParticles_webgl(this.links[a].number_particles,this.links[a]._id)},a.prototype.updateNodes=function(){console.log("YOOO UPDATE NODES");for(var a=0;a<this.nodes.length;a++)this.webGL_nodes[a].position.set(this.nodes[a].x,this.nodes[a].y,1)},a.prototype.set_tube_width=function(a,b){this.links[a].width_tube=b},a.prototype.set_tube_color=function(a,b,c){this.tube[a].children[0].material.color.setHex(b),this.tube[a].children[0].material.opacity=c},a.prototype.set_links_color=function(a,b){for(var c=0;c<this.curveSplines[a].children.length;c++)this.curveSplines[a].children[c].material.opacity=b},a.prototype.updateLabel=function(){console.log("UPDATE LABEL");for(var a=0;a<this.webGL_label.length;a++)this.webGL_label[a].position.x=this.nodes[a].x+18,this.webGL_label[a].position.y=this.nodes[a].y},a.prototype.updateTube=function(){console.log("UPDATE TUBE");for(var c=[],d=0;d<this.tube.length;d++){c[0]={x:this.links[d].source.x,y:this.links[d].source.y},c[1]={x:this.links[d].target.x,y:this.links[d].target.y};for(var e=c[0].x,f=c[0].y,g=c[1].x,h=c[1].y,i=this.tube[d].children[0],j=this.get_normal_position_border(e,f,g,h,this.links[d].width_tube,1),k=new THREE.SplineCurve([new THREE.Vector2(j[0].x,j[0].y),new THREE.Vector2(j[2].x,j[2].y)]),l=new THREE.SplineCurve([new THREE.Vector2(j[2].x,j[2].y),new THREE.Vector2(j[3].x,j[3].y)]),m=new THREE.SplineCurve([new THREE.Vector2(j[3].x,j[3].y),new THREE.Vector2(j[1].x,j[1].y)]),n=new THREE.SplineCurve([new THREE.Vector2(j[1].x,j[1].y),new THREE.Vector2(j[0].x,j[0].y)]),o=k.getSpacedPoints(50).concat(l.getSpacedPoints(50)).concat(m.getSpacedPoints(50)).concat(n.getSpacedPoints(50)),p=new THREE.Shape(o),q=new THREE.ShapeGeometry(p),r=0;r<q.vertices.length;r++)i.geometry.vertices[r].x=q.vertices[r].x,i.geometry.vertices[r].y=q.vertices[r].y,i.geometry.vertices[r].z=q.vertices[r].z;i.geometry.verticesNeedUpdate=!0,i.geometry.__dirtyVertices=!0,i.geometry.dynamic=!0}},a.prototype.createTube=function(){for(var b,a=[],f=0;f<this.links.length;f++){var g=new THREE.Object3D;a[0]={x:this.links[f].source.x,y:this.links[f].source.y},a[1]={x:this.links[f].target.x,y:this.links[f].target.y};var i=a[0].x,j=a[0].y,k=a[1].x,l=a[1].y,m=this.get_normal_position_border(i,j,k,l,3,1),n=new THREE.SplineCurve([new THREE.Vector2(m[0].x,m[0].y),new THREE.Vector2(m[2].x,m[2].y)]),o=new THREE.SplineCurve([new THREE.Vector2(m[2].x,m[2].y),new THREE.Vector2(m[3].x,m[3].y)]),p=new THREE.SplineCurve([new THREE.Vector2(m[3].x,m[3].y),new THREE.Vector2(m[1].x,m[1].y)]),q=new THREE.SplineCurve([new THREE.Vector2(m[1].x,m[1].y),new THREE.Vector2(m[0].x,m[0].y)]),r=n.getSpacedPoints(50).concat(o.getSpacedPoints(50)).concat(p.getSpacedPoints(50)).concat(q.getSpacedPoints(50)),s=new THREE.Shape(r),b=new THREE.ShapeGeometry(s),t=new THREE.MeshBasicMaterial({color:3447003,opacity:1,transparent:!0});t.opacity=1;var u=new THREE.Mesh(b,t);g.name="tube"+f,g.userData={type:"tube",id:this.links[f]._id},g.add(u),this.scene.add(g),this.tube.push(g)}},a.prototype.createLinks=function(){for(var b,c,d,a=[],e=0;e<this.links.length;e++){this.links[e].particleSystems=[],this.links[e].number_segmentation=50,this.links[e].curvePath=[],this.links[e].spatial_distribution=[],this.links[e].temporal_distribution=[],this.links[e].velocity=[],this.links[e].opacity=[],this.links[e].wiggling=[],this.links[e].size=[],this.links[e].gate_position=[],this.links[e].gate_colors=[],this.links[e].texture="rectangle_texture.png",this.links[e].number_particles=this.number_particles,this.links[e].gates=[],this.links[e].width_tube=this.tube_width,this.links[e].gates.push({object:"null",position:0});var f=new THREE.Object3D;a[0]={x:this.links[e].source.x,y:this.links[e].source.y},a[1]={x:this.links[e].target.x,y:this.links[e].target.y};var g=a[0].x,h=a[0].y,i=a[1].x,j=a[1].y,k=this.get_distance(g,h,i,j);this.links[e].number_segmentation=Math.floor(k/3);for(var l=this.get_normal_position_border(g,h,i,j,this.links[e].width_tube,this.number_paths_particule),m=0,n=0;m<l.length-1;m+=2,n++){var p=new THREE.SplineCurve([new THREE.Vector2(l[m].x,l[m].y),new THREE.Vector2(l[m+1].x,l[m+1].y)]);this.links[e].curvePath[n]=p.getSpacedPoints(this.links[e].number_segmentation),this.links[e].spatial_distribution[n]=0;var q=new THREE.LineBasicMaterial({color:2899536,linewidth:1,opacity:this.links_opacity,transparent:!0});c=new THREE.Path(p.getSpacedPoints(this.links[e].number_segmentation)),b=c.createPointsGeometry(this.links[e].number_segmentation),d=new THREE.Line(b,q),f.add(d)}this.links[e].gate_infos=[{factor:1,position:0},{factor:1,position:this.links[e].number_segmentation}],f.renderOrder=5,f.userData={type:"link",id:this.links[e]._id},this.curveSplines.push(f),this.links[e].userData={id:this.links[e]._id,number_particles:0},this.links[e].temporal_distribution=Array.apply(null,Array(this.number_particles)).map(Number.prototype.valueOf,0),this.links[e].velocity=Array.apply(null,Array(this.number_max_gates)).map(Number.prototype.valueOf,1),this.links[e].opacity=Array.apply(null,Array(this.number_max_gates)).map(Number.prototype.valueOf,1),this.links[e].wiggling=Array.apply(null,Array(this.number_max_gates)).map(Number.prototype.valueOf,0),this.links[e].size=Array.apply(null,Array(this.number_max_gates)).map(Number.prototype.valueOf,40),this.links[e].gate_position=[0,0,0,0,0,0,0,0,0,0];for(var m=0;m<this.number_max_gates;m++)this.links[e].gate_colors.push(new THREE.Vector3(1,1,1));this.scene.add(f)}},a.prototype.updateTube_width_gate=function(a,b,c){for(var e=this.links[a].gate_infos,f=[],g=0;g<2;g++){for(var h=[],i=0;i<e.length;i++){var j=this.get_normal_position(this.links[a].source.x,this.links[a].source.y,this.links[a].target.x,this.links[a].target.y,e[i].position,this.links[a].width_tube*e[i].factor,1);h.push(new THREE.Vector2(j[g].x,j[g].y))}for(var k=new THREE.SplineCurve(h),l=new THREE.Path(k.getSpacedPoints(50)),m=l.createPointsGeometry(50),n=[],i=0;i<m.vertices.length;i++)n.push(new THREE.Vector2(m.vertices[i].x,m.vertices[i].y));f.push(n)}f[0].reverse();var o=new THREE.SplineCurve([new THREE.Vector2(f[0][50].x,f[0][50].y),new THREE.Vector2(f[1][0].x,f[1][0].y)]),p=new THREE.SplineCurve([new THREE.Vector2(f[1][50].x,f[1][50].y),new THREE.Vector2(f[0][0].x,f[0][0].y)]),q=o.getSpacedPoints(50).concat(f[1]).concat(p.getSpacedPoints(50)).concat(f[0]);console.log(q);var r=new THREE.Object3D;r.name="tube"+a;var t=(this.tube[a].id,new THREE.Shape(q)),u=new THREE.ShapeGeometry(t),v=new THREE.MeshLambertMaterial({color:3447003,opacity:1});v.transparent=!0,v.opacity=1;var w=new THREE.Mesh(u,v);w.material.depthTest=!1,w.renderOrder=9999,r.userData={type:"tube",id:a},r.add(w);for(var x in u.vertices)this.tube[a].children[0].geometry.vertices[x].x=u.vertices[x].x,this.tube[a].children[0].geometry.vertices[x].y=u.vertices[x].y;this.tube[a].children[0].geometry.faces=u.faces,this.tube[a].children[0].geometry.computeBoundingSphere(),this.tube[a].children[0].geometry.verticesNeedUpdate=!0,this.tube[a].children[0].geometry.elementsNeedUpdate=!0,this.tube[a].children[0].geometry.morphTargetsNeedUpdate=!0,this.tube[a].children[0].geometry.uvsNeedUpdate=!0,this.tube[a].children[0].geometry.normalsNeedUpdate=!0,this.tube[a].children[0].geometry.colorsNeedUpdate=!0,this.tube[a].children[0].geometry.tangentsNeedUpdate=!0},a.prototype.updateLinks_width_gate=function(a,b,c){var d=this.links[a].gate_infos;d[b].factor=c;for(var e=0;e<12;e++){for(var f=[],g=0;g<d.length;g++){var h=this.get_normal_position(this.links[a].source.x,this.links[a].source.y,this.links[a].target.x,this.links[a].target.y,d[g].position,this.links[a].width_tube*d[g].factor,this.number_paths_particule);f.push(h[e])}var i=this.curveSplines[a].children[e],j=new THREE.SplineCurve(f),k=new THREE.Path(j.getSpacedPoints(50)),l=k.createPointsGeometry(50);i.geometry.vertices=l.vertices,i.geometry.verticesNeedUpdate=!0,this.links[a].curvePath[e]=j.getSpacedPoints(50)}this.updateParticles_Paths(a)},a.prototype.updateLinks=function(){for(var a=[],b=0;b<this.links.length;b++){a[0]={x:this.links[b].source.x,y:this.links[b].source.y},a[1]={x:this.links[b].target.x,y:this.links[b].target.y};var c=a[0].x,d=a[0].y,e=a[1].x,f=a[1].y,g=this.get_distance(c,d,e,f);this.links[b].number_segmentation=Math.floor(g/3);for(var h=this.get_normal_position_border(c,d,e,f,this.links[b].width_tube,this.number_paths_particule),i=0,j=0;i<h.length-1;i+=2,j++){var k=this.curveSplines[b].children[j],m=new THREE.SplineCurve([new THREE.Vector2(h[i].x,h[i].y),new THREE.Vector2(h[i+1].x,h[i+1].y)]);this.links[b].curvePath[j]=m.getSpacedPoints(this.links[b].number_segmentation);var o=(new THREE.LineBasicMaterial({color:2899536,linewidth:1,opacity:this.links_opacity,transparent:!0}),new THREE.Path(m.getSpacedPoints(this.links[b].number_segmentation))),p=o.createPointsGeometry(this.links[b].number_segmentation);k.geometry.vertices=p.vertices,k.geometry.verticesNeedUpdate=!0}}},a.prototype.updateParticles_Paths=function(a){for(var c=(this.links[a].userData.number_particles,this.links[a].particleSystems.material.__webglShader.uniforms),d=[],e=0;e<this.links[a].curvePath.length;e++)d=d.concat(this.links[a].curvePath[e]);c.path_general.value=d,console.log("PATHS",c.path_general)},a.prototype.updateParticles_Texture=function(a,b){var d=(this.links[a].userData.number_particles,this.links[a].particleSystems.material.__webglShader.uniforms);d.texture.value=(new THREE.TextureLoader).load("images/"+b),d.texture.name=b,console.log("TEXTURE",d.texture.value)},a.prototype.updateParticles_Velocity=function(a,b,c){var e=(this.links[a].userData.number_particles,this.links[a].particleSystems.material.__webglShader.uniforms);e.velocity.value[b]=c,console.log("VELOCITY",e.velocity.value)},a.prototype.updateParticles_Wiggling=function(a,b,c){var e=(this.links[a].userData.number_particles,this.links[a].particleSystems.material.__webglShader.uniforms);e.wiggling.value[b]=c,console.log("WIGGLING",e.wiggling.value)},a.prototype.updateParticles_Opacity=function(a,b,c){var e=(this.links[a].userData.number_particles,this.links[a].particleSystems.material.__webglShader.uniforms);e.opacity.value[b]=c,console.log("OPACITY",e.opacity.value)},a.prototype.updateParticles_Size=function(a,b,c){var e=(this.links[a].userData.number_particles,this.links[a].particleSystems.material.__webglShader.uniforms);e.size.value[b]=c,console.log("SIZE",e.size.value)},a.prototype.updateParticles_SpatialDistribution=function(a,b){console.log(a);for(var d=0;d<this.links.length;d++)if(this.links[d]._id==b){for(var e=0,f=0,g=0;g<a.length;g++){for(var h=0;h<a[g];h++)this.links[d].particleSystems.geometry.attributes.id.array[e]=f,e++;f++}this.links[d].particleSystems.geometry.attributes.id.needsUpdate=!0}},a.prototype.array_SpatialDistribution=function(a,b){for(var d=Array.apply(null,Array(a.length)).map(Number.prototype.valueOf,0),e=0,f=0,g=0;g<a.length;g++){for(var h=0;h<a[g];h++)d[e]=f,e++;f++}return d[b]},a.prototype.updateParticles_TemporalDistribution=function(a,b,c){for(var e=(this.links[b].userData.number_particles,this.links[b].particleSystems.material.__webglShader.uniforms),f=0;f<a.length;f++)e.temporal_delay.value[f]=Math.floor(-a[f])},a.prototype.updateParticles_TemporalDistribution2=function(a,b,c){for(var f=(this.links[b].userData.number_particles,this.links[b].particleSystems.material.__webglShader.uniforms),g=0,h=0;h<a.length;h++)for(var i=0;i<a[h];i++){var j=-50/c*h;f.temporal_delay.value[g]=Math.floor(j),g++}},a.prototype.updateParticles_Color=function(a,b,c){var e=(this.links[a].userData.number_particles,this.links[a].particleSystems.material.__webglShader.uniforms);e.gate_colors.value[c]=new THREE.Vector3(b.r,b.g,b.b)},a.prototype.updateParticles_Gates=function(a,b){for(var c=this.links[a].particleSystems.material.__webglShader.uniforms,e=1;e<c.gate_position.value.length;e++)if(0==c.gate_position.value[e]){c.gate_position.value[e]=b;break}console.log("GATE",c.gate_position),console.log("Temporal",c.temporal_delay)},a.prototype.updateParticle=function(){for(var g=0;g<this.links.length;g++)if(0!=this.links[g].particleSystems.length&&void 0!=this.links[g].particleSystems.material.__webglShader){var h=this.links[g].particleSystems.material.__webglShader.uniforms;h.uTime.value+=1}},a.prototype.createParticles_webgl=function(a,b){for(var c=this,d=[],e=0;e<this.links[b].curvePath.length;e++)d=d.concat(this.links[b].curvePath[e]);for(var f=this.links[b].temporal_distribution,g=this.links[b].velocity,h=this.links[b].opacity,i=this.links[b].wiggling,j=this.links[b].size,k=this.links[b].gate_position,l=this.links[b].gate_colors,m=this.links[b].number_segmentation,n={path_general:{type:"v2v",value:d},temporal_delay:{type:"iv1",value:f},velocity:{type:"fv1",value:g},size:{type:"fv1",value:j},opacity:{type:"fv1",value:h},wiggling:{type:"fv1",value:i},gate_position:{type:"iv1",value:k},gate_colors:{type:"v3v",value:l},particles_number:{type:"iv1",value:a},number_segmentation:{type:"iv1",value:m},uTime:{type:"f",value:1},time:{value:1},delta:{value:0},texture:{value:(new THREE.TextureLoader).load("images/"+this.links[b].texture),name:this.links[b].texture}},o=this.links[b].number_segmentation*(2*this.number_paths_particule),p=new THREE.ShaderMaterial({uniforms:n,vertexShader:"#define path_length "+o+"\n"+c.vertex_shader,fragmentShader:c.fragment_shader,depthTest:!1,transparent:!0}),r=new THREE.BufferGeometry,s=new Float32Array(3*a),t=new Float32Array(3*a),u=new Float32Array(a),v=new Float32Array(a),w=new Float32Array(a),y=(new Float32Array(4*a),new Float32Array(a)),e=(new THREE.Color,0),A=0;e<a;e++,A+=3)s[A+0]=0,s[A+1]=0,s[A+2]=0,t[A+0]=1,t[A+1]=1,t[A+2]=0,u[e]=1,y[e]=0,w[e]=e,v[e]=this.array_SpatialDistribution(this.links[b].spatial_distribution,e);return r.addAttribute("position",new THREE.BufferAttribute(s,3)),r.addAttribute("customColor",new THREE.BufferAttribute(t,3)),r.addAttribute("actual_velocity",new THREE.BufferAttribute(u,1)),r.addAttribute("id",new THREE.BufferAttribute(v,1)),r.addAttribute("id_particle",new THREE.BufferAttribute(w,1)),r.addAttribute("iteration",new THREE.BufferAttribute(y,1)),this.particleSystems=new THREE.Points(r,p),this.particleSystems.name="particle_system"+b,this.links[b].particleSystems=this.particleSystems,this.links[b].userData.number_particles=a,this.particleSystems.frustumCulled=!1,this.scene.add(this.particleSystems),console.log("particle created"),this.particleSystems},a.prototype.delete_entity_by_type=function(a){for(var b=0;b<this.scene.children.length;b++){var c=this.scene.children[b];c.userData.type==a&&this.scene.remove(c)}},a.prototype.get_normal_position=function(a,b,c,d,e,f,g){for(var h=f,i=[],k=(c-a)/50*e+a,l=(d-b)/50*e+b,m=(a-c)/(d-b),n=l-m*k,o=0;o<g;o++){var p=k+Math.sqrt(Math.pow(f,2)/(1+Math.pow(m,2))),q=m*p+n;i.push({x:p,y:q});var r=k-Math.sqrt(Math.pow(f,2)/(1+Math.pow(m,2))),s=m*r+n;i.push({x:r,y:s}),f-=h/this.number_paths_particule}return i},a.prototype.get_normal_position_border=function(a,b,c,d,e,f){for(var g=e,h=[],j=(a-c)/(d-b),k=0;k<f;k++){var l=a,m=b,n=m-j*l,o=l+Math.sqrt(Math.pow(e,2)/(1+Math.pow(j,2))),p=j*o+n,q=l-Math.sqrt(Math.pow(e,2)/(1+Math.pow(j,2))),r=j*q+n,l=c,m=d,j=(a-c)/(d-b),n=m-j*l,s=l+Math.sqrt(Math.pow(e,2)/(1+Math.pow(j,2))),t=j*s+n,u=l-Math.sqrt(Math.pow(e,2)/(1+Math.pow(j,2))),v=j*u+n;h.push({x:o,y:p}),h.push({x:s,y:t}),h.push({x:q,y:r}),h.push({x:u,y:v}),e-=2*g/(2*this.number_paths_particule-1)}return h},a.prototype.draw_circle=function(a,b){var c=new THREE.MeshBasicMaterial({color:15658734}),d=50,e=new THREE.CircleGeometry(.2,d),f=new THREE.Mesh(e,c);f.scale.set(1,1,1),f.name="circle",f.position.set(a,b,1),this.scene.add(f)},a.prototype.hslToRgb=function(a,b,c){var d,e,f;if(0==b)d=e=f=c;else{var g=function(b,c,d){return d<0&&(d+=1),d>1&&(d-=1),d<1/6?b+6*(c-b)*d:d<.5?c:d<2/3?b+(c-b)*(2/3-d)*6:b},h=c<.5?c*(1+b):c+b-c*b,i=2*c-h;d=g(i,h,a+1/3),e=g(i,h,a),f=g(i,h,a-1/3)}return[Math.round(255*d),Math.round(255*e),Math.round(255*f)]},a.prototype.getColor=function(a){var b=a<50?255:Math.floor(255-255*(2*a-100)/100),c=a>50?255:Math.floor(2*a*255/100);return b<0?new THREE.Vector3(1,0,0):new THREE.Vector3(b/255,c/255,0)},a.prototype.load_vertex_shaders=function(){var a=this;$.ajax({async:!1,url:"class/shaders/vertex.js",success:function(b){a.vertex_shader=b},dataType:"html"})},a.prototype.load_fragment_shaders=function(){var a=this;$.ajax({async:!1,url:"class/shaders/fragment.js",success:function(b){a.fragment_shader=b},dataType:"html"})},a.prototype.get_distance=function(a,b,c,d){var e=a-c,f=b-d,g=Math.sqrt(e*e+f*f);return g},a.prototype.fit_temporal_distribution=function(a){this.updateLinks();for(var b=0,c=(this.links[a].number_segmentation+1)/this.links[a].number_particles,d=0;d<this.links[a].number_particles;d++)this.links[a].temporal_distribution[d]=b,b+=c;this.links[a].spatial_distribution[0]=this.links[a].number_particles},a}();