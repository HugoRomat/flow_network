<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>confluent vs powergraph</title>

    <script src="lib/three.min.js"></script>
    <script src="lib/d3.js"></script>
    <script src="lib/networkcube.js"></script>
    <script src="lib/jquery.js"></script>
    <script src="lib/cola.min.js"></script>
    <script src="lib/topojson.v1.min.js"></script>
    <script src="class/confluent.js"></script>

    <script src="new_languages/parser.js"></script>

    <style>
        div{
            float: left;
            margin-right: 5px;
        }

    </style>

<!-- http://pegjs.org/online*/ -->

</head>
<body>
    <div id="visFrame"></div>
    <textarea id="instructions" rows="60" cols="50"></textarea>
    <button id="send">
        SEND
    </button>


    <script>



    function read_JSON_file(data)
    {
        var array = [];
        for (var i = 0; i < data.rules.length; i++){
            var block = data.rules[i];

            //console.log("BLOCK", block)

            //console.log("VALUE", block.selectors[0].qualifiers[0]["value"])

            for (var j in block.declarations){
                var attrName = block.declarations[j].name;
                var attrValue = [];
                //console.log(block.declarations[j].name, block.declarations[j].value["value"],block.declarations[j].value["type"],block.declarations[j].value["unit"]  )
                var value = block.declarations[j].value["value"];
                var name = block.declarations[j].name;
                var type = block.declarations[j].value["type"];
                var unit = block.declarations[j].value["unit"];

                array.push({"selector": block.selectors[0].qualifiers[0]["value"], "parameters": name, "value":value, "unit":unit})
                /*********** TO GET THE UNITY ****************/
                // for (var key in block.declarations[i].value){
                //     attrValue.push({"key": key, "value": block.declarations[i].value[key]})
                // }

            }

        }
        return array;

    }
    $('#send').click(function() {
        launch_network();
    });

    var my_projection = d3.geo.mercator()
                    .scale(900)
                    .translate([1500,500]);

    var delay_scale = d3.scale.linear()
                     .domain([0,140])
                     .range([0.01,5]);


    var color_scale = d3.scale.linear()
                     .domain([0,0])
                     .range([0, 0.5])
    var size_scale = d3.scale.linear()
                     .domain([0,0])
                     .range([20,150])
    function map_to_parameters(confluentGraph, array){

        var nodes = confluentGraph.nodes;
        var links = confluentGraph.links;

        max_number_flights = confluentGraph.get_max_of_attributes("number");
        max_passengers = confluentGraph.get_max_of_attributes("passengers");

        color_scale.domain([0, max_number_flights]);
        size_scale.domain([0, max_passengers]);


        for (var i =0; i<nodes.length;i++){
            var coordinates = my_projection([nodes[i].attr('long'),nodes[i].attr('lat')]);
            nodes[i].x = coordinates[0];
            nodes[i].y = - coordinates[1];
            confluentGraph.updateNode_color(i ,new THREE.Color("rgb(255, 255, 191)"), 10)
        }


        for (var i = 0;i<links.length; i++){
            //confluentGraph.updateParticles_Texture(i, "circle_texture.png");
            confluentGraph.set_tube_color(i, "0x3498db", 0.2);
            confluentGraph.set_tube_width(i, 0.1);

            var color = {r:255,g:0,b:0};
            var delay = parseFloat(links[i].attr('arr_delay'));
            var number_flights = links[i].attr('number');
            var attr_size = parseFloat(links[i].attr('passengers')) ;

            var color_custom = new THREE.Color().setHSL(0,1,color_scale(number_flights));

            //console.log(color)
            links[i].gate_colors[0] = color_custom;
            links[i].size[0] = size_scale(attr_size);
            //links[i].velocity[0] = delay_scale(delay);
        }

    }
    function launch_network(){

         networkcube.loadJson("data/TKM_data0.json", function(dataset){
            networkcube.importData("miserables", dataset);
            var graph = networkcube.getDynamicGraph(dataset.name, "miserables");
            var nodes = graph.nodes().toArray();
            var links = graph.links().toArray();
            var my_app = new Main("#visFrame",nodes , links, 900, 900, "#ffffff");

            var confluentGraph = my_app.confluentGraph;
            var my_mapping = my_app.mapping;

            confluentGraph.launch_network(1000, function(){

                var text = $('#instructions').val();

                // var json = PARSER.parse(".nodes { color : #711F1F; size : 8;}\
                //     .tube { size:0.1;  color : #711F1F;}\
                //     .particles {color:#29711F;}\
                //     .mapping_particles{size:arr_delay; color:passengers;}\
                //     .mapping_nodes{color:id;}");

                var json = PARSER.parse(".nodes { color : #711F1F; size : 8;}\
                    .tube { size:5.2;  color : #711F1F;}\
                    .particles {color:#29711F;}\
                    .mapping_particles{size:number_patent; color:number_publication;}\
                    .mapping_nodes{color:type;}");

                console.log(json)
                var array = read_JSON_file(json);



                my_mapping.map_from_array(array)
                confluentGraph.fit_all_temporal_distribution();

               my_mapping.launch_mapping()

            });

        });
    }


    </script>


</body>
</html>
